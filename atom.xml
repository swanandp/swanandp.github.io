<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Swanand Pagnis]]></title>
  <link href="http://info.pagnis.in/atom.xml" rel="self"/>
  <link href="http://info.pagnis.in/"/>
  <updated>2020-10-14T13:15:08+05:30</updated>
  <id>http://info.pagnis.in/</id>
  <author>
    <name><![CDATA[Swanand Pagnis]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Basic Financial Hygiene]]></title>
    <link href="http://info.pagnis.in/blog/2020/10/13/basic-financial-hygiene/"/>
    <updated>2020-10-13T19:21:32+05:30</updated>
    <id>http://info.pagnis.in/blog/2020/10/13/basic-financial-hygiene</id>
    <content type="html"><![CDATA[<p>How do you know your finances are in order? Are you on the right track? What should you do next?</p>

<p>Here is an essential checklist for good financial health. Do these things first, and then you can seek an advisor, planner, or wealth manager based on your needs. This list is <em>not an end-goal</em>; instead, it&rsquo;s a pre-requisite.</p>

<p>tl;dr üëáüèº</p>

<!-- more -->


<ul>
<li>Contingency Funds üíµ</li>
<li>Term and Health Insurance üè•</li>
<li>Equity to Debt Ratio ‚öñÔ∏è</li>
<li>Controlled expenses and regular investments üìà</li>
</ul>


<h2>1. Contingency Funds</h2>

<p>Save one full year of expenses in capital-preserved, safe financial instruments. These are ALL YOUR outgoing expenses: monthly rentals, EMIs, school fees, planned necessary purchases for the upcoming year. Name one, name all. Even if the markets crash and the economy tumbles, you need access to these funds.</p>

<p>It&rsquo;s quite likely that you are not in a position to put the whole year&rsquo;s worth in one go. In such a case, aim lower and build it up. Three months first, followed by six, then maybe ten, and finally, the whole year. Find your path.</p>

<p>A contingency fund is far more critical than low performing investments. Liquidate your worst performing and worst future-outlook assets if you need to. Many people have useless LIC policies, ULIPs, under-performing mutual funds. Research and swap them out. Some well-known avenues for research:</p>

<ul>
<li><a href="https://capitalmind.in/">https://capitalmind.in/</a></li>
<li><a href="https://indmoney.com/">https://indmoney.com/</a></li>
<li><a href="https://app.bankoncube.com/lead/upload/">https://app.bankoncube.com/lead/upload/</a></li>
<li><a href="https://www.smallcase.com/creators">https://www.smallcase.com/creators</a> (Curated list of advisors)</li>
</ul>


<p><strong>Why is your emergency fund necessary?</strong> <br/>
A contingency fund instantly improves your risk appetite. You can afford some additional risk because your baseline is now firm.</p>

<p>It also helps you get into a positive mindset. You can do things like taking a break, leaving a toxic job, trying something new, spending time with family, maybe even vacations. When you are not worried about putting food on the table, you can think better about other essential items.  üßòüèº‚Äç‚ôÇÔ∏è</p>

<p>If you&rsquo;re constantly worried about not having money, you will make poor choices out of a need for safety. Avoid that. Consider this anecdote from a friend:</p>

<blockquote><p>I left my job without another one in hand because I knew I had four months of runaway saved up. That same runway helped me reject a not-so-good offer because of the same mentality: I wanted to wait for a better offer to come my way.</p></blockquote>

<p>It&rsquo;s liberating.</p>

<h2>2. Term and Health Insurance</h2>

<p>Get appropriate amounts of insurance. How much is appropriate?</p>

<p><strong>Term insurance:</strong> 20x of your family&rsquo;s total annual expenses. If you Google around, you will find plenty of credible calculators from reputed institutions. But 15x or 20x is a good number. Start there.</p>

<p>Optimize for a hassle-free disbursement and high settlement ratio, not merely for a low premium. When the need arises to claim your insurance, your family and loved ones will be grieving. They won&rsquo;t be in a position to think through. Don&rsquo;t set them up for further doom. ü§ûüèº</p>

<p><strong>Health insurance:</strong> This is a far more nuanced discussion, but take as high a cover as you can. 20L, 30L, higher! Let your budget and comfort guide you. There are plans like &ldquo;super top-up&rdquo; that raise your floor by a considerable margin. Utilize them.</p>

<p>The idea is not to leave your dependents and loved ones stranded.</p>

<h2>3. Equity to Debt Ratio</h2>

<p>Not counting your emergency fund, make sure you have a healthy distribution of equity and debt instruments ‚Äî  60:40 and 70:30 are extremely popular ratios, and for a good reason. The central idea behind the balance is, of course, risk negation.</p>

<p>Your equity exposure drives your growth, and your debt portfolio gives you stability.</p>

<p>Use planning services to gauge your ratio and work on improving it first. If you have too much equity, stop your equity SIPs and switch to debt instead and vice versa. Give yourself a year to fix the ratio.</p>

<p>Debt instruments are not to be judged based on their year-over-year growth. No. That is not their primary job. Having a good, firm debt portfolio enables you to take risks in your equity game. This way, even if your equity risks try to bring you down, your stability from debt will shield you.</p>

<p>I will repeat, your equity exposure drives your growth, and your debt portfolio gives you stability.</p>

<h2>4. Controlled expenses and regular investments</h2>

<p>None of the above will matter if you can&rsquo;t control your expenditure or don&rsquo;t invest regularly. It&rsquo;s a commitment, no less. I have <a href="http://info.pagnis.in/blog/2020/05/31/spending-less/">written about spending less</a> before.</p>

<p>Spending as little as you can and investing as much as you can is almost a lifestyle. The good thing is you get to decide what &ldquo;little&rdquo; and &ldquo;much&rdquo; mean to you.</p>

<h2>What next?</h2>

<p><strong>That&rsquo;s all, folks!</strong> You have everything you need, and you are now ready for a more advanced course of action. This course of action looks something like:</p>

<ul>
<li>Portfolio management services (PMS)</li>
<li>Certified financial planners (CFP)</li>
<li>Self-guided investments</li>
</ul>


<p>PMS is an excellent choice if you can afford it. For advisory and planning, the world is moving towards a &ldquo;fee-only&rdquo; model. It&rsquo;s hard to make the incentives align in a commissions model. Services like Clearcase are making it easy for us to take our own investment decisions. YMMV!</p>

<p>Let your budget and risk appetite guide you. Consult experts for all critical decisions.</p>

<p>Happy investing! üí∞</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Use The French Press, Luke!]]></title>
    <link href="http://info.pagnis.in/blog/2020/10/12/use-the-french-press-luke/"/>
    <updated>2020-10-12T15:47:19+05:30</updated>
    <id>http://info.pagnis.in/blog/2020/10/12/use-the-french-press-luke</id>
    <content type="html"><![CDATA[<p>If you&rsquo;re getting started with brewing your own coffee, use the French Press.  We will see why in this post. And we will also see a recommended setup towards the end.</p>

<p>So you decided to make your own coffee. Wonderful! ü§ó I am willing to bet that the decision to start brewing your own coffee came after consuming <em>content</em> related to coffee. Maybe you&rsquo;ve been watching James Hoffmann&rsquo;s videos. Perhaps you&rsquo;ve been looking at Blue Bottle&rsquo;s exceedingly rare collections. Or maybe you have friends who tweet about coffee, sharing their pictures, setups, recipes. But you&rsquo;re in. By the grace of the mighty civet&rsquo;s tail, you&rsquo;re sold.</p>

<p><img src="http://info.pagnis.in/assets/distracted-bf-coffee.jpg" alt="Distracted boyfriend meme: distracted by reading about coffee when he should be making coffee" width="75%" /></p>

<p>So what next?</p>

<!-- more -->


<p>AeroPress‚Ñ¢? French Press? Pour-overs? Moka pots? Espresso? Wouldn&rsquo;t you love to make some latte art? Which coffee to buy? Intelligentsia? Blue Bottle? Blue Tokai? Kaapi Kotai? So many options, and <strong>all good</strong> ones. The age of third-wave coffee is kind. We have great choices all around.</p>

<p>But it pays rich dividends to set your goal on <em>learning better</em> as you make your daily cup. Nobody makes a perfect cup on their first few attempts. Sure, you can make a good one, but don&rsquo;t fool yourself. Consistency is the key. It takes umpteen iterations to settle on to a taste and brewing level you like and is actually good.</p>

<blockquote><p>Never buy a Steinway Concert Grand if you&rsquo;re just beginning to learn how to play the piano. Buy a Yamaha semi-weighted digital piano instead. You will know when to buy the Steinway.</p></blockquote>

<p><strong>Start with a French Press.</strong></p>

<h2>Why, though?</h2>

<h3>French Press is simple</h3>

<p>Unlike its cousins AeroPress‚Ñ¢ or Pour-over, which have specific techniques, the Press pot is simple. Grind coffee, mix a proportionate amount of hot water, start the timer, pour when it rings. The tiny details and intricacies can come later. They <em>will</em> come later. The important thing is that this simple recipe <strong>reduces your barrier</strong> to brewing. You need to start brewing and tasting.</p>

<h3>French Press allows a wide range of experiments</h3>

<p>There are <em>many</em> factors that go into the taste and extraction of the coffee. Not all are equally important. Some are foundational, some are marginal, some others are downright refined. Using a good baseline and then playing with these factors will quickly help you find your way.</p>

<p>All brewing methods allow experimenting, some more than others. With Espresso, there&rsquo;s little room for grind size and water temperature. With Pour-Over, there&rsquo;s a small room for the coffee-water ratio. With AeroPress‚Ñ¢, there&rsquo;s a small room for air pressure. With the Press, you can experiment quite easily with the following:</p>

<ul>
<li>Coffee to water ratio</li>
<li>Grind size</li>
<li>Brew time</li>
<li>Water temperature</li>
</ul>


<p>It&rsquo;s not that other methods prevent experimentation; the point is that French Press allows a lot of experimentation. It&rsquo;s a plus for <em>this</em> technique, not a minus for others. Experimenting will let you refine factors that work for you. It took me 1 year with 10 different coffees and 300+ cups to settle on something I like, and now it&rsquo;s been 5 more years since then. I can brew a cup I like with precision, but I still keep trying things out. Most coffee lovers do.</p>

<p>Some outcomes from my early experiments:</p>

<ul>
<li>I found that dark roasts need precise timing; otherwise, they over-extract quickly.</li>
<li>I typically prefer a 1:13 coffee to water ratio, but this changes with different coffees. Some of the lighter roasts I buy work better with 1:12</li>
<li>I discovered that I like Central American coffees over other coffees.</li>
<li>Brewing longer than suggested times doesn&rsquo;t necessarily make a more potent brew, but it does make a bitter brew.</li>
<li>Under-extracted coffee has a distinctly sour taste</li>
<li>Boiling water works just as well with French Press, as the recommended 195¬∫F</li>
</ul>


<h3>With French Press, it&rsquo;s easier to brew coffee that isn&rsquo;t bitter</h3>

<p>Bitterness is a downer for a large majority. You grow out of it. You learn to embrace some bitter and accept it as a part of the coffee taste. But in the beginning, when you can&rsquo;t brew consistently, it is a significant impediment to learning. Both Pour-over and AeroPress‚Ñ¢ take precise techniques to make a smooth, low bitterness extraction. Not French Press. Get a good light roast or medium roast coffee.</p>

<p>That ease of experimenting we discussed earlier helps with this too. Too bitter? Increase the grind size. Change the ration‚Äîlower the temperature, etc.</p>

<h2>Your First Setup</h2>

<p>Settled on French Press as the method of brewing. Now what? You need to buy the equipment. You need only need the following to start with:</p>

<ol>
<li>Good coffee. Of course!</li>
<li>A press pot</li>
<li>A coffee grinder</li>
<li>A weighing scale, preferably with tare</li>
</ol>


<p>What follows is my recommended setup. Some qualities of this setup:</p>

<ol>
<li>Not expensive</li>
<li>It will serve you at least a couple of years</li>
<li>It will not compromise your taste</li>
</ol>


<p>Onward, then.</p>

<h3>1. Good Coffee:</h3>

<p>The BIG question! This is going to differ based on geographies, but these are my stock &ldquo;first&rdquo; recommendations:</p>

<ol>
<li><a href="https://bluetokaicoffee.com/products/m-s-estate-certified-organic?variant=35890488520">MS Estate Organic Arabica</a>. Many sellers, but BlueTokai has been roasting and selling this for the longest time.</li>
<li>Riverdale Estate. Again, many sellers, so go with your favorite. I personally like BlueTokai and CorridorSeven for Riverdale.</li>
<li>Blue Bottle&rsquo;s <a href="https://bluebottlecoffee.com/store/three-africas">Three Africas</a> Blend.</li>
<li>Square Mile&rsquo;s <a href="https://shop.squaremilecoffee.com/products/the-filter-blend">Filter Blend</a>. Many newcomers look down upon blends and tend to prefer Single Origin. A mistake! It&rsquo;s foolish to ignore the coffee masters. Good blends are well worth it.</li>
<li>Parama by Maverick and Farmer</li>
<li>Attikan Estate by BlueTokai</li>
</ol>


<p>Try one, try all. But don&rsquo;t forget to buy whole beans. Freshly ground coffee makes all the difference. If you are unwilling to get a grinder and buy whole beans, you might as well give up.</p>

<h3>2. Your Coffee Maker a.k.a Press Pot</h3>

<p>Buy the <a href="https://www.amazon.com/KONA-Reusable-Stainless-Comfortable-Protecting/dp/B00JTKZR5K?th=1">smallest Kona press pot</a> you can find. No more than 4 cup capacity. If you can&rsquo;t get a Kona, get Cafe Jei or Mueller. All 3 of these have superior filters that leave the sediments and grounds out of your coffee. They also prevent extended brewing. This is important.</p>

<h3>3. Grinder</h3>

<p>You must buy a precision grinder. This is perhaps the most essential part of the setup. Freshly ground coffee makes all the difference and uniform grinding is an absolute must for brewing. Precision usually means buying a conical burr grinder.</p>

<p>The choice between manual and electric is simple. Start at manual. There&rsquo;s something cathartic about the process of grinding the beans.</p>

<p>I recommend the <a href="https://www.savorworksroasters.com/product-page/timemore-chestnut-c2-manual-coffee-grinder">Timemore C</a> series. They&rsquo;re precise and extremely smooth to operate. You can upgrade to a <a href="https://benkibrewingtools.com/shop/ols/products/comandante-coffee-grinder">Comandante</a> ‚Äî  the best manual grinder money can buy for those with higher budgets.</p>

<p>If you want to jump straight to electric, the Baratza Encore is an unequivocal choice. Sturdy, reliable, precise.</p>

<h3>4. Weighing Scale</h3>

<p>Give up on volumetric measurements. No one tablespoon this and one cup that üö´. Start with mass measurements. Grams for coffee. Grams for water. And for that, you will need a weighing scale. Any off-the-shelf scale from Amazon works. Here are the things you need:</p>

<ul>
<li>0.5gm precision</li>
<li>Tare functionality</li>
<li>Good reviews</li>
</ul>


<p>Let your budget be a guide.</p>

<p>That is it. These are all the things you need to buy. I assumed you have a phone you can use as a timer, and you can get hot water as needed.</p>

<h2>The recipe</h2>

<p>There is no shortage of excellent brewing guides out there. All popular third-wave coffee roasters and sellers have their own.</p>

<p>Before you read those brewing guides, read this <a href="https://www.homegrounds.co/coffee-grind-chart">grind size guide</a> first. And then this <a href="https://www.homegrounds.co/how-to-use-a-french-press">excellent brewing guide.</a> That&rsquo;s all you&rsquo;ll need. You can refer to other handbooks as you figure things out.</p>

<p>That&rsquo;s all, folks! You have everything you need: Motivation to make good coffee, necessary equipment, some knowledge, and coffee beans. Start making your coffee and experimenting and finding your taste!</p>

<p>Happy brewing! ‚òï</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Notes from 'Blind Spots of the Developer Entrepreneur']]></title>
    <link href="http://info.pagnis.in/blog/2020/07/11/notes-from-developer-entrepreneur-talk/"/>
    <updated>2020-07-11T22:45:00+05:30</updated>
    <id>http://info.pagnis.in/blog/2020/07/11/notes-from-developer-entrepreneur-talk</id>
    <content type="html"><![CDATA[<p>At the 2017 MicroConf, <a href="https://twitter.com/r00k">Ben Orenstein</a> spoke about &ldquo;The Blind Spots of the Developer Entrepreneur&rdquo;. It was <a href="https://www.youtube.com/watch?v=n078RDNz6jY">a talk packed with insights</a> and actionable advice for the developer-entrepreneur.</p>

<p>The target audience for the talk is someone who wants to start their own business but hasn&rsquo;t begun. But even if you don&rsquo;t fit this criterion, it still offers value in the methodical approach it prescribes.</p>

<p>Personally, the talk resonated with me and renewed my interest in wanting to teach and building a viable business out of teaching.</p>

<p>Here are my notes from the talk. The points are his, the phrasing is mine.</p>

<!-- more -->


<h2>Part 1: First steps üë£</h2>

<p>The talk is prescriptive. Why? Because when you are starting, you need someone to give you specific instructions.</p>

<p>Progress over perfection. Move that needle.</p>

<p>Ben used an apt analogy of cooking: It would help a great deal if you had recipes when you begin. But you evolve into experimentation only after you cross an expertise threshold.</p>

<p>He also shared his journey as a maker where he started teaching Vim to other developers, a topic he was passionate about. This journey ended up creating a well-loved platform that came to be known as &ldquo;Upcase&rdquo; by ThoughtBought.</p>

<p>He&rsquo;s been there and done that.</p>

<p>There are 2 phases to the beginner&rsquo;s journey.</p>

<h3>Phase 1: Teach üéì</h3>

<p>The first big question: <strong>What do I teach?</strong></p>

<p><em>What would&rsquo;ve saved you agony if you knew it when you were working on something?</em></p>

<p><em>What are people asking you about?</em> This prompt is useful since it indicates that you already evoke some trust in others.</p>

<p><em>What are some things you spend much time on or enjoy doing that other people find annoying?</em> Ben gave an anecdotal example of his friend, who <em>loved</em> spending time on invoices and timesheets and chose his first product from this habit: invoicing for freelancers. A much-dreaded task for a vast majority of freelancers.</p>

<p>The second big question: <strong>How do I teach?</strong></p>

<p>Start small, personal, and free.</p>

<ul>
<li>Teach co-workers something related to their everyday work</li>
<li>Give lightning talks at conferences and meetups &mdash; they&rsquo;re an excellent avenue for packing insights into one short, concise session.</li>
<li>An informal Hangouts/Zoom session</li>
</ul>


<p>When you teach, don&rsquo;t just teach, interact. üó£Ô∏è</p>

<ul>
<li>Ask people about themselves</li>
<li>Where they work</li>
<li>What excited them about attending this session</li>
<li>What was the best thing they learned</li>
<li>What were the problems</li>
</ul>


<p>These questions and their answers reveal astonishing details about your teachings. You can use those to refine and get better. <em>Get better.</em></p>

<p>As you start teaching, and people start learning from you, you need a way to keep in touch &mdash; collect their emails. You don&rsquo;t have to start a newsletter right away, find a way to inform them of your new content.</p>

<h3>Phase 2: Pre-sell an info product</h3>

<p><strong>Goal: Sell <em>one</em> copy to <em>one</em> stranger.</strong> ü§ù</p>

<p>Never start with a SaaS unless you have research to prove the merit; they&rsquo;re much harder to sell.</p>

<p>Start with an info product. A guide. A book. Tutorials.</p>

<p><em>Write one chapter through a process of complete immersion.</em></p>

<p>Take 4-5 days off from your schedule. Focus heavily &mdash; ignore everything else you can ignore. Don&rsquo;t write the introduction or pitch; write a meaty chapter. Go down the trenches and write one of the book&rsquo;s central chapters. And write the table of contents.</p>

<p>Tell them what you&rsquo;re going to tell them. üéôÔ∏è</p>

<p>Create a sales page on Leanpub or Gumroad or a similar service. Do not attempt to write code for this sales page. Nope. Have a page ready where people can pay you money and buy your book. Before. You. Complete. It.</p>

<p>Don&rsquo;t wait for inspiration. It will come in leaps and bounds when you find success. Even micro-success brings inspiration.</p>

<p>Ben alludes to a survey he did at the conference, where it turned out that about 50% of the attendees had $0 revenue because they hadn&rsquo;t started. And about 50% of the attendees felt inspired, and the rest didn&rsquo;t.</p>

<p>And there was substantial overlap with those who did not yet feel inspired and those who had not started.</p>

<p>Don&rsquo;t wait for inspiration. Put in the work.</p>

<p>Get started &ndash;> Small success &ndash;> Inspiration &ndash;> More work &ndash;> More success</p>

<p>Ben mentioned the thrill he felt when he put up a $9 video about getting better at Vim, and strangers bought it. üí∞</p>

<p>Recommended reading: <a href="https://www.goodreads.com/book/show/1319.The_War_of_Art">The War of Art</a></p>

<h2>Part 2: Ben&rsquo;s Ten Best Tactics</h2>

<p>We have a Ben 10 here.</p>

<p>These don&rsquo;t necessarily apply to beginners or info products. They are appropriate for all digital businesses.</p>

<p><strong> 1Ô∏è‚É£ </strong> Create a recurring reminder to run a pricing test every six months.</p>

<p>Raise your rates. Hide your lowest pricing tier.</p>

<p>There are numerous examples of people doubling and tripling their prices, and still growing.</p>

<p><strong> 2Ô∏è‚É£ </strong> Create an email course. Drip it over 4-5 days. Make it a good, tight content based on genuine value. Remember the &ldquo;what to teach&rdquo; lessons.</p>

<p><strong> 3Ô∏è‚É£ </strong> Integrate and partner with other businesses and products &mdash; a potent formula for creating win-win situations.</p>

<p>Here, Ben shared two examples:</p>

<ul>
<li>A Zapier integration they did, which led to Zapier covering them in a blog post, which in turn led to a massive uptick in customers</li>
<li>He struck a partnership with a competing product with a slightly different niche, leading to an additional $100k revenue for both of them in a span of weeks.</li>
</ul>


<p><strong> 4Ô∏è‚É£ </strong> Sell annual plans. There are a lot of nifty patterns around yearly billing. The reason they work is that they&rsquo;re mutually beneficial.</p>

<p><strong> 5Ô∏è‚É£ </strong> Put faces near things you want people to click. Humans beings are drawn to faces by nature.</p>

<p>Think CTAs, subscribe buttons. Put faces.</p>

<p><strong> 6Ô∏è‚É£ </strong> Try a diving-save. Reach out personally to someone who churned and make an offer that&rsquo;s well worth it. Figure out why someone is canceling and use that to offer some value around it. e.g., you get a cancellation because the student does not have time to work through. Offer them a discounted annual pack so that they have additional time.</p>

<p><strong> 7Ô∏è‚É£ </strong> Start a podcast. A great way to get industry-famous people to talk about you. A great way to get traffic and attention. Podcasts have a vast audience. Utilize it.</p>

<p><strong> 8Ô∏è‚É£ </strong> Manually onboard customers. Yes, for real. Get on a screen sharing call with them and ask them to walk you through as they sign up and start using your service.</p>

<p>It will open up your blindspots and delight you. Or make you cry. Improvements either way!</p>

<p><strong> 9Ô∏è‚É£ </strong> Double down on things that work. You might feel the need to be experimentative or creative, but instead, focus on things that work. It works.</p>

<p><strong> üîü </strong> Ask for help.</p>

<p>Ask successful people in the same industry. You will be surprised how willing people are to help. As a corollary, be prepared to help others.</p>

<p><strong>Fin.</strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[A Job Post from the Past]]></title>
    <link href="http://info.pagnis.in/blog/2020/06/04/a-job-post-from-the-past/"/>
    <updated>2020-06-04T20:38:32+05:30</updated>
    <id>http://info.pagnis.in/blog/2020/06/04/a-job-post-from-the-past</id>
    <content type="html"><![CDATA[<p>Back in 2019, I wrote a job post that I soon became fond of. Proud even. It received healthy attention and consistent praise:</p>

<ul>
<li>To the point without unnecessary fluff</li>
<li>Exciting and warm to read</li>
<li>Mentorship offered</li>
<li>Thank you for no buzzwords</li>
</ul>


<p>It also buried me in applications and responses. A good problem to have! Publishing the post here for posterity&rsquo;s sake.</p>

<!-- more -->




<blockquote class="twitter-tweet">
  <p lang="en" dir="ltr">
    I am hiring for my team at Deserve. Here&#8217;s the job post. DM here or apply on HasJob. RTs appreciated! <a href="https://t.co/dlWubdyu1S">https://t.co/dlWubdyu1S</a>
  </p>
  &mdash; Swanand (@_swanand) <a href="https://twitter.com/_swanand/status/1187026754239492097?ref_src=twsrc%5Etfw">October 23, 2019</a>
</blockquote>


<script src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


<h2>Join the team at Deserve! üöÄ</h2>

<h3>The company</h3>

<ol>
<li>ü¶Ñ Bay-area based, funded, and growing startup in the fintech space. Quite soon, we&rsquo;ll be looking at the U word with hopeful eyes.</li>
<li>üí≥ Credit Card for people starting their credit journey (think university students in the USA)</li>
<li>üìà SaaS. We&rsquo;re also a &ldquo;credit card-as-a-service&rdquo;, meaning banks and NBFCs can launch their cards through us.</li>
</ol>


<h3>The team and the tech</h3>

<ol>
<li>üåè Distributed across timezones</li>
<li>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Variety of backgrounds: Big companies, start-ups, remote teams, co-located teams. Been there, done that.</li>
<li>‚òï A warm, friendly bunch of people who are pleasant to work with.</li>
<li>‚òÅÔ∏è A mix of classic and cloud-native infra: Django, RDS PostgreSQL, Ruby on Rails, AWS Lambda, Kinesis, DocumentDB, CloudFormation, Dockerized deployments</li>
<li>ü§ñ Infrastructure as code, immutable infrastructure</li>
</ol>


<h3>What do we expect</h3>

<ol>
<li>You primarily identify as a backend engineer and are comfortable working on the server-side.</li>
<li>You can write non-trivial programs in either Ruby or Python. If you don&rsquo;t know either, you can learn a language quickly.</li>
<li>You can write clean, modular code in either Object-Oriented style or Functional style.</li>
<li>You are fluent in using at least one DB, preferably PostgreSQL, but feel free to surprise us.</li>
<li>You have shipped code to production recently, regularly.</li>
<li>You are driven and care about doing a good job and improving your craft.</li>
<li>You are fluent in using the tools of the trade: Editors, Git, Command line, Slack, Jira (unfortunately yes)</li>
<li>You have high integrity, and you are reliable.</li>
</ol>


<p><strong>Don&rsquo;t worry too much about fitting each of these requirements. Use your discretion, think which are most important to you, and then apply.</strong></p>

<h3>What do you get</h3>

<ol>
<li>üí∞ Good pay. We&rsquo;re not AmaGooFaceFlixSoft, but we will pay well enough that money alone wouldn&rsquo;t be a blocker for you joining</li>
<li>üë©üèº‚Äçüè´ Mentorship and a chance to grow professionally</li>
<li>üï¥Ô∏è A chance at a career-building stint. Deserve is in excellent shape, and poised to become significant.</li>
<li>üéâ A chance to define the company culture, be a stakeholder in how we do things. Don&rsquo;t like something? Make your case; change it.</li>
<li>üôåüèº A friendly interview process that you will enjoy participating</li>
</ol>


<h3>When applying, please send us:</h3>

<ol>
<li>Your LinkedIn profile or your resume, preferably both.</li>
<li>A snippet of code you wrote recently and are proud of, and why you are proud of it.</li>
<li>Create a GitHub gist (or equivalent) with the above things, and send it to us through this platform.</li>
</ol>


<h3>Job Perks</h3>

<ol>
<li>üíª Brand new laptop. We&rsquo;re all on 15&#8221; MacBook Pros so far.</li>
<li>üñ• Ô∏è27&#8221; 4k Display</li>
<li>‚å® üñ± External keyboard and mouse</li>
<li>üå¥ Regular, all-expenses-paid team on-sites in both India and the USA</li>
<li>üè¢ Offices in Pune and Bangalore, and occasional remote work</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Behavioral Science and the Art of Spending Less]]></title>
    <link href="http://info.pagnis.in/blog/2020/05/31/spending-less/"/>
    <updated>2020-05-31T20:30:05+05:30</updated>
    <id>http://info.pagnis.in/blog/2020/05/31/spending-less</id>
    <content type="html"><![CDATA[<p>There are four popular ways of growing your wealth:</p>

<ol>
<li>Spending less</li>
<li>Investing wisely</li>
<li>Earning more</li>
<li>Getting lucky</li>
</ol>


<p>They all differ in their effectiveness and difficulty of implementation.</p>

<ol>
<li>Spending less:  the easiest of all</li>
<li>Investing wisely: difficult; requires expertise</li>
<li>Earning more: not easy, but the most effective</li>
<li>Getting lucky: ¬Ø\_(„ÉÑ)_/¬Ø</li>
</ol>


<p>&ldquo;Spending less&rdquo; is the low hanging fruit out of the four. It&rsquo;s directly tied to human behavior, and we can apply techniques backed by research to help us spend less.</p>

<!-- more -->


<h2>The Science</h2>

<p>The <a href="https://www.behaviormodel.org/">Fogg Behavior Model</a> states that behavior occurs at the intersection of 3 things:</p>

<ol>
<li><em>Prompt</em> for an action</li>
<li><em>Motivation</em> to do the action</li>
<li><em>Ability</em> to perform the action</li>
</ol>


<p><img src="http://info.pagnis.in/assets/b-eq-map_small@2x.jpg" alt="Fogg Behavior Model" width="75%" /></p>

<p><sub>Image used with appropriate permission from BJ Fogg</sub></p>

<p>Some examples:</p>

<ul>
<li>Upon encountering a bug üêû in the Linux OS (<em>prompt</em>), I may have a strong desire (<em>motivation</em>) to submit a patch to the Linux kernel, but it&rsquo;s well beyond my <em>ability</em> to do so. I will not do it. üòÖ</li>
<li>After brushing my teeth in the morning (<em>prompt</em>), I can easily do 20 pushups (<em>ability</em>). But. I. Just. Want. My. Coffee. ‚òï (<em>motivation</em>)</li>
<li>I see a bowl of cashews and dates on the dinner table (<em>prompt</em>). I love dates (<em>motivation</em>). I will pick them up and eat (<em>ability</em>)</li>
</ul>


<p><strong>To summarise:</strong></p>

<p>When we&rsquo;re prompted to act, if we have the <em>ability</em> to do it <strong>and</strong> high enough a <em>motivation</em> to do it, we do it. If either is lacking, we don&rsquo;t.</p>

<p>Spending falls in this same model.</p>

<ul>
<li>You&rsquo;re on Twitter, someone tweets a picture of something enticing you&rsquo;ve been thinking buying, you go to Amazon and buy it with a few clicks. ‚úÖ</li>
<li>A friend tells you about an excellent book they&rsquo;re reading; you go to Goodreads, find the reviews and descriptions. You&rsquo;re convinced. You buy. ‚úÖ</li>
<li>You hear about a great electric bike that looks fabulous and seems like a perfect fit for you. You notice the price is way out of your budget. You don&rsquo;t buy it. üö´</li>
</ul>


<p>So how do we use what we learned above? Often the easiest way is to remove the prompts. It works like a charm. But it&rsquo;s not always possible. The prompts <em>will</em> occur, and we will have to rely on reduced motivation and reduced ability to prevent the action.</p>

<h2>A strategy for minimizing spending</h2>

<ul>
<li>Figure out a reasonable expenditure cap for your household, say ‚Çπ X0,000/month üí∏</li>
<li>This includes all outgoing: rents, EMIs, groceries, eat-outs, credit card payments, shopping, what have you. üè† üõçÔ∏è ü•ò (Review this figure twice a year)</li>
<li>Dedicate an account for these expenses. Each month, put this amount there. Direct ALL YOUR SPENDING to <em>this</em> account. <em>All.</em> üîë</li>
<li>When you run out of money in this account, DO NOT SPEND. üôÖüèº‚Äç‚ôÇÔ∏è üö´</li>
<li>If you use credit cards, you can only spend what you have in THIS ACCOUNT. No more. No converting into EMIs. üí≥</li>
<li>Do not deviate far from your personality. e.g., I love occasional shopping and splurging, and so I account for it. Moderation is key. Without it, you will fall off the wagon quickly. ‚úãüèº üõë</li>
<li>If you can, rely on spouses, partners, parents, children for accountability. Return the favor and be accountable for them. üë™</li>
<li>Account for annual, non-monthly, and aperiodic expenses. Insurance policies, vacations, school fees, furniture, laptops, what have you.  üéí üèñ üèîÔ∏è üíª</li>
<li>Distribute the amount monthly. Put it in liquid funds (consult experts for this) connected to the same spending account. üí∞</li>
<li>Direct ALL THOSE EXPENSES to <em>this</em> account. <em>All.</em> üîë</li>
<li>Seeding/overdraft: Sometimes significant expenses come before you&rsquo;ve accrued enough in the expense account. Have an overdraft margin for it and treat it as a loan to yourself.</li>
<li>A reasonable limit allows you to spend just enough to have a happy lifestyle and yet limits spending. ‚öñÔ∏è</li>
</ul>


<h2>Parting thoughts</h2>

<p>We accepted that spending prompts <em>will</em> occur. By decreasing our ability to spend we&rsquo;ve pushed the prompt from action zone to no action zone.</p>

<p>Relying on motivation alone is a strategy fraught with peril. By gaming ability and prompts, you can prevent bad behavior or encourage good behavior. Spending less is just one tiny application of this powerful technique.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Demystifying SQL Queries]]></title>
    <link href="http://info.pagnis.in/blog/2017/08/19/deconstructing-sql-queries/"/>
    <updated>2017-08-19T11:36:19+05:30</updated>
    <id>http://info.pagnis.in/blog/2017/08/19/deconstructing-sql-queries</id>
    <content type="html"><![CDATA[<p>Let&rsquo;s look at an average, everyday SQL query:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">something</span>
</span><span class='line'><span class="k">FROM</span> <span class="k">table</span>
</span><span class='line'><span class="k">WHERE</span> <span class="n">conditions</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not hard to draw parallels to other known concepts: <!-- more --></p>

<ol>
<li>FROM table: A set of elements</li>
<li>WHERE conditions:  A filter operation on these elements</li>
<li>SELECT something: A presenter of an individual element</li>
</ol>


<h2>Tables are sets</h2>

<p>The bare minimum way of interacting with a set, is to take a look at <em>some or all</em> of its elements. That is exactly what this query is doing. We&rsquo;re selecting a subset of a set, based on a few conditions, and representing each element of this subset in some format.  Recall that a subset of a set is <em>also a set</em> in itself.  Which allows us to do something like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">something</span>
</span><span class='line'><span class="k">FROM</span> <span class="p">(</span>
</span><span class='line'>  <span class="k">SELECT</span> <span class="n">something</span>
</span><span class='line'>  <span class="k">FROM</span> <span class="k">table</span>
</span><span class='line'>  <span class="k">WHERE</span> <span class="n">conditions</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="k">WHERE</span> <span class="n">conditions</span>
</span></code></pre></td></tr></table></div></figure>


<p>We have a nested query, where instead of selecting from a table, we&rsquo;re selecting from the result of selecting from a table. <sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></p>

<p>Sets can have labels or aliases, so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">a_name</span><span class="p">.</span><span class="n">something</span>
</span><span class='line'><span class="k">FROM</span> <span class="p">(</span>
</span><span class='line'>  <span class="k">SELECT</span> <span class="n">something</span>
</span><span class='line'>  <span class="k">FROM</span> <span class="k">table</span>
</span><span class='line'>  <span class="k">WHERE</span> <span class="n">conditions</span>
</span><span class='line'><span class="p">)</span> <span class="k">as</span> <span class="n">a_name</span>
</span><span class='line'><span class="k">WHERE</span> <span class="n">conditions</span>
</span></code></pre></td></tr></table></div></figure>


<p>We seem to be doing some recursive looking stuff, and I find it beautiful.</p>

<p>Which also means, an assertion is in order: <strong>a select query operates upon a set, and returns a set</strong>.  Naturally, a set can be a that of a single element as well.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="k">table</span> <span class="k">WHERE</span> <span class="n">conditions</span>
</span><span class='line'><span class="c1">--- better yet:</span>
</span><span class='line'><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">something</span> <span class="k">FROM</span> <span class="k">table</span> <span class="k">WHERE</span> <span class="n">conditions</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s substitute <em>this set</em> in our original query:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">the</span> <span class="n">same</span> <span class="n">something</span>
</span><span class='line'><span class="k">FROM</span>
</span><span class='line'>  <span class="p">(</span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">something</span> <span class="k">FROM</span> <span class="k">table</span> <span class="k">WHERE</span> <span class="n">conditions</span><span class="p">)</span>
</span><span class='line'><span class="k">WHERE</span> <span class="n">conditions</span>
</span></code></pre></td></tr></table></div></figure>


<p>So a select query operates upon a set, and returns a set, and we know that sets can be unioned or intersected:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'>  <span class="k">SELECT</span> <span class="n">something</span>
</span><span class='line'>  <span class="k">FROM</span> <span class="p">(</span><span class="n">a</span> <span class="k">set</span><span class="p">)</span>
</span><span class='line'>  <span class="k">WHERE</span> <span class="n">conditions</span>
</span><span class='line'><span class="k">UNION</span> <span class="c1">-- or INTERSECTION</span>
</span><span class='line'>  <span class="k">SELECT</span> <span class="n">the</span> <span class="n">same</span> <span class="n">something</span>
</span><span class='line'>  <span class="k">FROM</span> <span class="p">(</span><span class="n">a</span> <span class="k">similar</span> <span class="k">set</span><span class="p">)</span>
</span><span class='line'>  <span class="k">WHERE</span> <span class="n">conditions</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice that &ldquo;something&rdquo; and &ldquo;the same something&rdquo; are important.  We can only union or intersection similar sets.  Apples and oranges can&rsquo;t be unioned in the relational algebra land.</p>

<h2>Joins are Sets</h2>

<p>Let&rsquo;s talk about joins.  Chances are, at some point in life you&rsquo;ve written in INNER JOIN instead of an OUTER JOIN and got incorrect results.  Or something along those lines.  Joins can be very opaque, even to a regular practitioner.</p>

<p>A few things are important when considering joins:</p>

<ol>
<li>A join is a product of 2 sets. Always. Multi-table joins are just &ldquo;first join these two&rdquo;, &ldquo;take the result&rdquo; and &ldquo;join the result with the next&rdquo;.</li>
<li>Joins are always performed on sets.  So you can &ldquo;join&rdquo; any of the above mentioned sets, and you&rsquo;re still good. Do note that language semantics dictate that you use aliases to disambiguate.</li>
<li>NULL is always a part of each set.  Implicitly so, for practicality.</li>
</ol>


<p>This is best explained through an example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">numbers</span> <span class="o">=</span> <span class="err">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="err">}</span>
</span><span class='line'><span class="n">letters</span> <span class="o">=</span> <span class="err">{</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="k">c</span> <span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Joining <code>numbers</code> and <code>letters</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">numbers</span> <span class="o">|</span> <span class="n">letters</span>
</span><span class='line'><span class="c1">--------|---------</span>
</span><span class='line'><span class="k">NULL</span>    <span class="o">|</span> <span class="k">NULL</span>
</span><span class='line'><span class="k">NULL</span>    <span class="o">|</span> <span class="n">a</span>
</span><span class='line'><span class="k">NULL</span>    <span class="o">|</span> <span class="n">b</span>
</span><span class='line'><span class="k">NULL</span>    <span class="o">|</span> <span class="k">c</span>
</span><span class='line'><span class="mi">1</span>       <span class="o">|</span> <span class="k">NULL</span>
</span><span class='line'><span class="mi">1</span>       <span class="o">|</span> <span class="n">a</span>
</span><span class='line'><span class="mi">1</span>       <span class="o">|</span> <span class="n">b</span>
</span><span class='line'><span class="mi">1</span>       <span class="o">|</span> <span class="k">c</span>
</span><span class='line'><span class="mi">2</span>       <span class="o">|</span> <span class="k">NULL</span>
</span><span class='line'><span class="mi">2</span>       <span class="o">|</span> <span class="n">a</span>
</span><span class='line'><span class="mi">2</span>       <span class="o">|</span> <span class="n">b</span>
</span><span class='line'><span class="mi">2</span>       <span class="o">|</span> <span class="k">c</span>
</span><span class='line'><span class="mi">3</span>       <span class="o">|</span> <span class="k">NULL</span>
</span><span class='line'><span class="mi">3</span>       <span class="o">|</span> <span class="n">a</span>
</span><span class='line'><span class="mi">3</span>       <span class="o">|</span> <span class="n">b</span>
</span><span class='line'><span class="mi">3</span>       <span class="o">|</span> <span class="k">c</span>
</span></code></pre></td></tr></table></div></figure>


<p>Do you get the feeling that you are getting more than what you bargained for?  Me too.  Depending on context, we&rsquo;ll want different subsets of this mega joined set.  That&rsquo;s exactly what different kinds of joins are for.  These joins will determine what working set we&rsquo;ll use.</p>

<ol>
<li>Inner join:  Do not consider the entries which have NULL on either side.</li>
<li>Left outer join: Do not consider entries which have NULL on the LEFT side.</li>
<li>Right outer join: Do not consider entries which have NULL of the RIGHT side.</li>
<li>Full outer join: Consider all entries.</li>
</ol>


<p>For practical reasons, the entry where both sides are NULL is not considered.
A slightly better example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">numbers</span> <span class="o">=</span> <span class="err">{</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="k">c</span><span class="p">]</span> <span class="err">}</span>
</span><span class='line'><span class="n">letters</span> <span class="o">=</span> <span class="err">{</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="k">c</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span> <span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">JOIN</span>
</span><span class='line'>  <span class="n">numbers</span> <span class="k">AND</span> <span class="n">letters</span>
</span><span class='line'><span class="k">ON</span> <span class="k">second</span> <span class="n">element</span> <span class="k">of</span> <span class="nb">number</span> <span class="o">=</span> <span class="k">first</span> <span class="n">element</span> <span class="k">of</span> <span class="n">letter</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our working set:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">numbers</span> <span class="o">|</span> <span class="n">letters</span>
</span><span class='line'><span class="c1">--------|---------</span>
</span><span class='line'><span class="k">NULL</span>    <span class="o">|</span> <span class="k">NULL</span>
</span><span class='line'><span class="k">NULL</span>    <span class="o">|</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
</span><span class='line'><span class="k">NULL</span>    <span class="o">|</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
</span><span class='line'><span class="k">NULL</span>    <span class="o">|</span> <span class="p">[</span><span class="k">c</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span>  <span class="o">|</span> <span class="k">NULL</span>
</span><span class='line'><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="k">c</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span>  <span class="o">|</span> <span class="k">NULL</span>
</span><span class='line'><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="k">c</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="k">c</span><span class="p">]</span>  <span class="o">|</span> <span class="k">NULL</span>
</span><span class='line'><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="k">c</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="k">c</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="k">c</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="k">c</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>After applying conditions, and removing both sides NULL entry:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">numbers</span> <span class="o">|</span> <span class="n">letters</span>
</span><span class='line'><span class="c1">--------|---------</span>
</span><span class='line'><span class="k">NULL</span>    <span class="o">|</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
</span><span class='line'><span class="k">NULL</span>    <span class="o">|</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
</span><span class='line'><span class="k">NULL</span>    <span class="o">|</span> <span class="p">[</span><span class="k">c</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span>  <span class="o">|</span> <span class="k">NULL</span>
</span><span class='line'><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span>  <span class="o">|</span> <span class="k">NULL</span>
</span><span class='line'><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="k">c</span><span class="p">]</span>  <span class="o">|</span> <span class="k">NULL</span>
</span><span class='line'><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="k">c</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="k">c</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Rearranging a little, for better understanding:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">numbers</span> <span class="o">|</span> <span class="n">letters</span> <span class="o">|</span> <span class="n">included</span> <span class="k">in</span>
</span><span class='line'><span class="c1">--------|---------|-----------</span>
</span><span class='line'><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>  <span class="o">|</span> <span class="k">Full</span><span class="p">,</span> <span class="k">Inner</span><span class="p">,</span> <span class="k">Left</span> <span class="k">and</span> <span class="k">Right</span>
</span><span class='line'><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>  <span class="o">|</span> <span class="k">Full</span><span class="p">,</span> <span class="k">Inner</span><span class="p">,</span> <span class="k">Left</span> <span class="k">and</span> <span class="k">Right</span>
</span><span class='line'><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="k">c</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="k">c</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span>  <span class="o">|</span> <span class="k">Full</span><span class="p">,</span> <span class="k">Inner</span><span class="p">,</span> <span class="k">Left</span> <span class="k">and</span> <span class="k">Right</span>
</span><span class='line'><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span>  <span class="o">|</span> <span class="k">NULL</span>    <span class="o">|</span> <span class="k">Full</span> <span class="k">and</span> <span class="k">Left</span>
</span><span class='line'><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span>  <span class="o">|</span> <span class="k">NULL</span>    <span class="o">|</span> <span class="k">Full</span> <span class="k">and</span> <span class="k">Left</span>
</span><span class='line'><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="k">c</span><span class="p">]</span>  <span class="o">|</span> <span class="k">NULL</span>    <span class="o">|</span> <span class="k">Full</span> <span class="k">and</span> <span class="k">Left</span>
</span><span class='line'><span class="k">NULL</span>    <span class="o">|</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>  <span class="o">|</span> <span class="k">Full</span> <span class="k">and</span> <span class="k">Right</span>
</span><span class='line'><span class="k">NULL</span>    <span class="o">|</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>  <span class="o">|</span> <span class="k">Full</span> <span class="k">and</span> <span class="k">Right</span>
</span><span class='line'><span class="k">NULL</span>    <span class="o">|</span> <span class="p">[</span><span class="k">c</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span>  <span class="o">|</span> <span class="k">Full</span> <span class="k">and</span> <span class="k">Right</span>
</span></code></pre></td></tr></table></div></figure>


<p>Left and Right are determined from the join syntax.  When A joins B, A is Left, and B is Right.</p>

<p>While attempting to write a join query, I encourage you to work out your join on paper first, with dummy data.  Specially with multi-table joins.</p>

<h2>Functions are Sets</h2>

<p>That sounded nice, but it isn&rsquo;t true. Functions aren&rsquo;t sets, they <em>operate</em> on sets.  Remember, a single value is also a set, so <strong>each function accepts a set as an argument, and returns a set</strong>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">anything</span><span class="p">.</span><span class="n">today</span>
</span><span class='line'><span class="k">FROM</span>
</span><span class='line'><span class="p">(</span> <span class="k">SELECT</span> <span class="n">now</span><span class="p">()</span> <span class="k">AS</span> <span class="n">today</span> <span class="p">)</span> <span class="k">AS</span> <span class="n">anything</span>
</span></code></pre></td></tr></table></div></figure>


<p>My apologies for dropping a query on you without any domain context, but consider this slightly more complex function, which returns all the sibling branches of a given restaurant branch.  Restaurant has many Restaurant Branches, and Restaurant Branch belongs to a Restaurant, to aid your understanding.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="n">co_branches</span><span class="p">(</span><span class="n">branch_id</span> <span class="nb">BIGINT</span><span class="p">)</span>
</span><span class='line'>  <span class="k">RETURNS</span> <span class="k">TABLE</span><span class="p">(</span><span class="n">id</span> <span class="nb">BIGINT</span><span class="p">)</span>
</span><span class='line'><span class="k">AS</span> <span class="err">$</span><span class="k">function</span><span class="err">$</span>
</span><span class='line'>
</span><span class='line'><span class="k">SELECT</span> <span class="n">b2</span><span class="p">.</span><span class="n">id</span>
</span><span class='line'><span class="k">FROM</span>
</span><span class='line'>  <span class="n">restaurant_branches</span> <span class="n">b1</span>
</span><span class='line'>  <span class="k">JOIN</span> <span class="n">restaurant_branches</span> <span class="n">b2</span> <span class="k">ON</span> <span class="n">b1</span><span class="p">.</span><span class="n">restaurant_id</span> <span class="o">=</span> <span class="n">b2</span><span class="p">.</span><span class="n">restaurant_id</span>
</span><span class='line'><span class="k">WHERE</span> <span class="n">b1</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">branch_id</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="err">$</span><span class="k">function</span><span class="err">$</span>
</span><span class='line'><span class="k">LANGUAGE</span> <span class="k">SQL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">--- used simply:</span>
</span><span class='line'><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">COBRANCHES</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span> <span class="c1">-- Co-branches of Branch#42</span>
</span><span class='line'><span class="c1">--- But more powerful, when used like:</span>
</span><span class='line'><span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">COBRANCHES</span><span class="p">(</span><span class="n">id</span><span class="p">))</span> <span class="k">as</span> <span class="n">branch_count</span> <span class="k">FROM</span> <span class="n">restaurant_branches</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;re basically replacing a query with a function.  And we learned that both SELECT queries and Functions operate on sets, and return sets.</p>

<p>Which brings me to another assertion: <strong>Sets and set operations tend to compose well.</strong>  This is very important! Functional programming nerds practically live by this motto.  Once you have small units that compose well, you can build complex units with relative simplicity.</p>

<p>Fundamentally, SQL is not so different.  An important thing to keep in mind that this composing behaviour is mainly about the data and how the data is interpreted and processed. The query language itself leaves a lot to be desired when it comes to composing.  A lot of things like aliases, joins can easily be taken care by a competent library.  But, more or on this, and the advantages of using something like ARel in a later post.</p>

<h2>Reading is destructuring, Writing is composing</h2>

<p>Let&rsquo;s collect all the set-like behaviour we&rsquo;ve seen so far:</p>

<ul>
<li>We can interact with a set by looking at all or some of its elements</li>
<li>A subset of a set is <em>also a set</em> in itself</li>
<li>A set can have a label or an alias</li>
<li>A set can be a that of a single element as well</li>
<li>A set can be unioned or intersected with another set</li>
</ul>


<p>Reading or writing complex queries becomes much easier, if we think of it as composing queries together, or decomposing a large query into smaller parts.</p>

<h3>How to read complex queries</h3>

<ul>
<li>Start with the innermost, or smallest &ldquo;SELECT&rdquo; clauses</li>
<li>Replace them with an appropriately and descriptively named function, say <code>co_branches_of_given_branch</code> instead of just <code>co_branches</code>.

<ul>
<li>If these inner queries, now functions, use a column / value from the outer queries, treat them as function arguments. ( <code>co_branches</code> used <code>branch_id</code> )</li>
</ul>
</li>
<li>Keep applying this method until you reach the outermost query.</li>
</ul>


<h3>How to write complex queries</h3>

<p>This really boils down to a top-down vs bottom-up approach. If you&rsquo;re a top-down person:
&ndash; Write the top-most query, assume all the lower level functions exist, with appropriate and descriptive names.
&ndash; Recursively, apply the same strategy to each lower level function</p>

<p>Conversely, if you&rsquo;re a bottom-up person:
&ndash; Figure out the lowest level functions / queries you need, and write them
&ndash; Build up your larger query by composing these functions.</p>

<!-- Links and footnotes -->



<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Food for thought: How many nested select queries does your favourite relational database allow?<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Consuming HTTP APIs in Ruby]]></title>
    <link href="http://info.pagnis.in/blog/2017/07/08/consuming-http-apis-in-ruby/"/>
    <updated>2017-07-08T18:07:41+05:30</updated>
    <id>http://info.pagnis.in/blog/2017/07/08/consuming-http-apis-in-ruby</id>
    <content type="html"><![CDATA[<p>What is your favourite technique for consuming HTTP APIs in Ruby?  I like using <a href="https://github.com/jnunemaker/httparty">HTTParty</a>!</p>

<ul>
<li>It offers a simple, intuitive API.</li>
<li>It makes it easy to support a whole bunch of standard API authentication mechanisms. <!-- more --></li>
<li>It de-serialises responses based on content type headers.</li>
<li>It allows us to write simple wrappers that are very close in form to the API we want to communicate with.</li>
<li>It has a nice name!  And we know <a href="https://twitter.com/timbray/status/817025379109990402?cn=cmVwbHk%3D">how hard it is to name things</a>.</li>
</ul>


<p>I have come to employ a few patterns when working with HTTParty.  They are all centered around having a convenient internal API to work with, and the ease of testing.</p>

<p>Most APIs I&rsquo;ve worked with have one of the following authentication mechanism:</p>

<ul>
<li>HTTP Basic Authentication</li>
<li>HTTP Digest Authentication</li>
<li>Auth token in header</li>
<li>API key in query params / request body</li>
</ul>


<p>I am really fond of examples, so let&rsquo;s consider an example.  A RESTful service, where we interact with the &ldquo;Article&rdquo; resource.  We&rsquo;re able to list articles, get details about an article, create, update &amp; delete an article.  The service demands HTTP Basic auth, and JSON encoding.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ArticlesService</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">HTTParty</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">base_uri</span> <span class="s2">&quot;https://api.example.com&quot;</span>
</span><span class='line'>  <span class="n">read_timeout</span> <span class="mi">5</span> <span class="c1"># always have timeouts!</span>
</span><span class='line'>  <span class="c1"># debug_output $stdout # for quick access during debugging</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:auth</span><span class="p">,</span> <span class="ss">:headers</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>    <span class="vi">@auth</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="ss">username</span><span class="p">:</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;API_USERNAME&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">password</span><span class="p">:</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;API_PASSWORD&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>    <span class="n">get</span><span class="p">(</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">article_id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">get</span><span class="p">(</span><span class="s2">&quot;articles/</span><span class="si">#{</span><span class="n">article_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span><span class='line'>      <span class="n">endpoint</span><span class="p">(</span><span class="s2">&quot;articles&quot;</span><span class="p">),</span>
</span><span class='line'>      <span class="n">default_options</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">body</span><span class="p">:</span> <span class="n">attributes</span><span class="o">.</span><span class="n">to_json</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">article_id</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span>
</span><span class='line'>      <span class="n">endpoint</span><span class="p">(</span><span class="s2">&quot;articles/</span><span class="si">#{</span><span class="n">article_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
</span><span class='line'>      <span class="n">default_options</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">body</span><span class="p">:</span> <span class="n">attributes</span><span class="o">.</span><span class="n">to_json</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="n">article_id</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
</span><span class='line'>      <span class="n">endpoint</span><span class="p">(</span><span class="s2">&quot;articles/</span><span class="si">#{</span><span class="n">article_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
</span><span class='line'>      <span class="n">default_options</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">protected</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">default_options</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="ss">headers</span><span class="p">:</span> <span class="n">headers</span><span class="p">,</span>
</span><span class='line'>      <span class="n">basic_auth</span><span class="p">:</span> <span class="n">auth</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</span><span class='line'>    <span class="s2">&quot;/v1/</span><span class="si">#{</span><span class="n">uri</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span class='line'>      <span class="n">endpoint</span><span class="p">(</span><span class="n">uri</span><span class="p">),</span>
</span><span class='line'>      <span class="n">default_options</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here&rsquo;s why I like this code:</p>

<ol>
<li>Simple, easy to read code that mimics the API quite nicely.</li>
<li>Intuitive. Sending a POST request, is as simple as calling <code>post</code>.  No need to remember multiple things. Specifying headers, is literally passing an argument called <code>headers</code>.</li>
<li>Interacting with the API is now simple:</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">service</span> <span class="o">=</span> <span class="no">ArticlesService</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>
</span><span class='line'><span class="n">pp</span> <span class="n">service</span><span class="o">.</span><span class="n">index</span>
</span><span class='line'><span class="c1"># []</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Create an article</span>
</span><span class='line'><span class="n">response</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span class='line'>  <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Star Trek: A new hope&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">body</span><span class="p">:</span> <span class="s2">&quot;A play about how Frodo is</span>
</span><span class='line'><span class="s2">         tricked into attending the</span>
</span><span class='line'><span class="s2">         tri-wizard tournament by</span>
</span><span class='line'><span class="s2">         evil shogun Gandalf&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Made a mistake in the title, update it</span>
</span><span class='line'><span class="n">service</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span class='line'>  <span class="n">response</span><span class="o">[</span><span class="s1">&#39;article&#39;</span><span class="o">][</span><span class="s1">&#39;id&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Star Wars: Into the darkness&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Delete that abomination of an article</span>
</span><span class='line'><span class="n">service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">response</span><span class="o">[</span><span class="s1">&#39;article&#39;</span><span class="o">][</span><span class="s1">&#39;id&#39;</span><span class="o">]</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Where&rsquo;s the fun without ever changing requirements?</p>

<p>API, now V2, demands that we use digest auth, instead of basic auth.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">default_options</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="ss">headers</span><span class="p">:</span> <span class="n">headers</span><span class="p">,</span>
</span><span class='line'>    <span class="n">digest_auth</span><span class="p">:</span> <span class="n">auth</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</span><span class='line'>  <span class="s2">&quot;/v2/</span><span class="si">#{</span><span class="n">uri</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>That was a simple change. Let&rsquo;s try adding custom headers.  The API now supports logging, tracking and tagging requests. All done through headers. Since this is context specific, we&rsquo;ll pass in the context as an argument to the constructor:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@auth</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">username</span><span class="p">:</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;API_USERNAME&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">password</span><span class="p">:</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;API_PASSWORD&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="vi">@headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;X-User-ID&quot;</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">tracking_id</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;X-Tags&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Name:</span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In addition to basic auth,  we can also send in an oauth style &ldquo;Bearer&rdquo; token:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;X-User-ID&quot;</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">tracking_id</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;X-Tags&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Name:</span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;Authorisation&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Bearer:</span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">oauth_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Okay, this last example was lame.  But the point remains, HTTParty allows you to build your own service objects, and gets out of your way.  Exactly what a library should do.</p>

<p>If you really take a close look at our examples, consuming an HTTP API is all about:</p>

<ul>
<li>Setting Headers</li>
<li>Specifying Query parameters</li>
<li>Request body encoding</li>
<li>Parsing response based on content type</li>
<li>Making the HTTP requests</li>
</ul>


<p>Not surprising, right?  HTTParty makes it simple, and intuitive to perform all these actions.  And hence it remains my favourite.</p>

<p>P.S.  Here&rsquo;s the code used above, <a href="https://gist.github.com/swanandp/51d24ca474b10b10c68f2afeb30dc65e">in a Gist</a>.</p>

<!-- Links -->



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Postgres Text Search: Simple, Adequate]]></title>
    <link href="http://info.pagnis.in/blog/2017/06/18/postgres-text-search-simple-adequate/"/>
    <updated>2017-06-18T00:00:00+05:30</updated>
    <id>http://info.pagnis.in/blog/2017/06/18/postgres-text-search-simple-adequate</id>
    <content type="html"><![CDATA[<p>Searching for text within your data is a frequently requested feature, and often leads to excellent UX.  Gmail&rsquo;s web interface is entirely built on top of search. No wonder databases have supported basic text search operators like ~, LIKE, ILIKE etc for a long time.  But they often fall short or give inaccurate results, as we try to evolve the feature.  Say, searching in multiple languages, or searching for different variants of the same word: consider realistically, realistic, and realist, or <a href="https://www.google.co.in/#q=ruby+-jewel">searching one word, but not the other</a>.</p>

<p>This is where full-text search comes in.  <!-- more --> Postgres ships with excellent full-text search capabilities which allow us to implement text search in our application without incurring additional dependencies and operational overhead.  More over, having a built-in search allows us to compose search with other existing queries and procedures.  When I say excellent capabilities, I mean fully-featured.  And when I say fully-featured, I mean that it supports stemming, search relevance, search highlights, fuzzy matching, and multiple languages.</p>

<p>In this post, we&rsquo;ll look at basic text search.  In particular, we&rsquo;ll look at the fundamental components of a text search, and how to use them.</p>

<p><strong>Document</strong></p>

<p>This is the source data within which we intend to search. Typically spread across multiple columns. Now, I know any search worth its salt must be able to search across multiple rows in multiple tables, but we&rsquo;ll come to that bit a little later in the post.  Postgres offers a function <code>to_tsvector</code> to obtain a search document from text.  It accepts text as an argument, and returns tsvector of the text.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="c1">-- Example 1a: tsvector</span>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span>
</span><span class='line'>   <span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;With great power, comes great responsibility!&#39;</span><span class="p">)</span>
</span><span class='line'>   <span class="k">AS</span> <span class="n">document</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">document</span>
</span><span class='line'><span class="c1">--------------------------------------------</span>
</span><span class='line'> <span class="s1">&#39;come&#39;</span><span class="p">:</span><span class="mi">4</span> <span class="s1">&#39;great&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span> <span class="s1">&#39;power&#39;</span><span class="p">:</span><span class="mi">3</span> <span class="s1">&#39;respons&#39;</span><span class="p">:</span><span class="mi">6</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- Example 1b: have strings, will concat</span>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span>
</span><span class='line'>   <span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;With great power&#39;</span> <span class="o">||</span> <span class="s1">&#39; &#39;</span> <span class="o">||</span> <span class="s1">&#39;comes great responsibility!&#39;</span><span class="p">)</span>
</span><span class='line'>   <span class="k">AS</span> <span class="n">document</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                  <span class="n">document</span>
</span><span class='line'><span class="c1">--------------------------------------------</span>
</span><span class='line'> <span class="s1">&#39;come&#39;</span><span class="p">:</span><span class="mi">4</span> <span class="s1">&#39;great&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span> <span class="s1">&#39;power&#39;</span><span class="p">:</span><span class="mi">3</span> <span class="s1">&#39;respons&#39;</span><span class="p">:</span><span class="mi">6</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- Example 1c: have tsvectors, will concat</span>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span>
</span><span class='line'>   <span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;With great power&#39;</span><span class="p">)</span>
</span><span class='line'>   <span class="o">||</span> <span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;comes great responsibility!&#39;</span><span class="p">)</span>
</span><span class='line'>   <span class="k">AS</span> <span class="n">document</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                  <span class="n">document</span>
</span><span class='line'><span class="c1">--------------------------------------------</span>
</span><span class='line'> <span class="s1">&#39;come&#39;</span><span class="p">:</span><span class="mi">4</span> <span class="s1">&#39;great&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span> <span class="s1">&#39;power&#39;</span><span class="p">:</span><span class="mi">3</span> <span class="s1">&#39;respons&#39;</span><span class="p">:</span><span class="mi">6</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>A few things are noticeable:</p>

<ol>
<li>Punctuation is gone, so is &lsquo;with&rsquo;.  All commonly occurring words that don&rsquo;t have search relevance, such as &lsquo;with&rsquo;, are removed from the documents.  These differ from language to language, and are called &ldquo;stop words&rdquo;.</li>
<li>Words are reduced to a base form. These are called as &ldquo;<a href="https://www.postgresql.org/docs/current/static/textsearch-intro.html">lexemes</a>&rdquo;; they are nothing but normalised forms of words, a term taken from <a href="https://en.wikipedia.org/wiki/Lexeme">linguistics</a>.</li>
<li>The lexemes are sorted alphabetically, There are numbers associated with the lexemes.</li>
<li>The tsvectors can be concatenated, <em>or</em> can operate on concatenated strings</li>
</ol>


<p>If you want to dig deeper into how the search actually works, these are some of the things you can read about.  For now, we&rsquo;ll focus on just one thing from this:  the to_tsvector accepted our text input, and returned a searchable value.</p>

<p>As a side note, I really like this examples driven approach to learning.  Code and examples make for easier understanding of the subject, and give the reader a starting point to dig deeper.  In that spirit, this blog post is a repl-driven-blog-post.</p>

<p><strong>Query</strong></p>

<p>The term we wish to search for.  Typically a word or a phrase , but can be any text. Even a full document if you will. For obtaining a query object from the given search string, Postgres has two functions: <code>to_tsquery</code> and <code>plainto_tsquery</code>. <code>to_tsquery</code> allows us to use control characters like wildcards, but is a lot stricter with the input. <code>plainto_tsquery</code> on the other hand doesn&rsquo;t use control characters, but escapes all the input, and is safe from SQL injection.  In this post we&rsquo;ll only look at to_tsquery since it falls in line with our &ldquo;fully featured&rdquo; requirement.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="c1">-- Example 2: tsquery</span>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;responsibility&#39;</span><span class="p">);</span>
</span><span class='line'> <span class="n">to_tsquery</span>
</span><span class='line'><span class="c1">------------</span>
</span><span class='line'> <span class="s1">&#39;respons&#39;</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- Example 3: tsquery multiple words, with escaping</span>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;great\ responsibility&#39;</span><span class="p">);</span>
</span><span class='line'>     <span class="n">to_tsquery</span>
</span><span class='line'><span class="c1">---------------------</span>
</span><span class='line'> <span class="s1">&#39;great&#39;</span> <span class="o">&amp;</span> <span class="s1">&#39;respons&#39;</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- Example 4: Wildcard search</span>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;Eliz:*&#39;</span><span class="p">);</span>
</span><span class='line'> <span class="n">to_tsquery</span>
</span><span class='line'><span class="c1">------------</span>
</span><span class='line'> <span class="s1">&#39;eliz&#39;</span><span class="p">:</span><span class="o">*</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- Example 5: Intersection (AND-ing)</span>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;Barry&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;Allen&#39;</span><span class="p">);</span>
</span><span class='line'>     <span class="o">?</span><span class="k">column</span><span class="o">?</span>
</span><span class='line'><span class="c1">-------------------</span>
</span><span class='line'> <span class="s1">&#39;barri&#39;</span> <span class="o">&amp;</span> <span class="s1">&#39;allen&#39;</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- Example 5: Union (OR-ing)</span>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;Barry&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;Wally&#39;</span><span class="p">);</span>
</span><span class='line'>     <span class="o">?</span><span class="k">column</span><span class="o">?</span>
</span><span class='line'><span class="c1">-------------------</span>
</span><span class='line'> <span class="s1">&#39;barri&#39;</span> <span class="o">|</span> <span class="s1">&#39;walli&#39;</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Examples demonstrate the various usages of to_tsquery.  Wildcards, AND and OR do exactly what you&rsquo;d expect them to do.  The key takeaway is that, these are just regular functions, like <code>LOWER</code>, <code>LENGTH</code> and so we can just use them in <em>any</em> query.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="c1">-- Example 6</span>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span>
</span><span class='line'>   <span class="n">name</span><span class="p">,</span>
</span><span class='line'>   <span class="n">to_tsvector</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">document</span>
</span><span class='line'>   <span class="k">FROM</span> <span class="n">states</span>
</span><span class='line'>   <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">name</span> <span class="k">ASC</span>
</span><span class='line'>   <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="n">name</span>         <span class="o">|</span>         <span class="n">document</span>
</span><span class='line'><span class="c1">----------------------+---------------------------</span>
</span><span class='line'> <span class="n">Alabama</span>              <span class="o">|</span> <span class="s1">&#39;alabama&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">Alaska</span>               <span class="o">|</span> <span class="s1">&#39;alaska&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">Arizona</span>              <span class="o">|</span> <span class="s1">&#39;arizona&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">Arkansas</span>             <span class="o">|</span> <span class="s1">&#39;arkansa&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">California</span>           <span class="o">|</span> <span class="s1">&#39;california&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">Colorado</span>             <span class="o">|</span> <span class="s1">&#39;colorado&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">Connecticut</span>          <span class="o">|</span> <span class="s1">&#39;connecticut&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">Delaware</span>             <span class="o">|</span> <span class="s1">&#39;delawar&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">District</span> <span class="k">of</span> <span class="n">Columbia</span> <span class="o">|</span> <span class="s1">&#39;columbia&#39;</span><span class="p">:</span><span class="mi">3</span> <span class="s1">&#39;district&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">Florida</span>              <span class="o">|</span> <span class="s1">&#39;florida&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'><span class="p">(</span><span class="mi">10</span> <span class="k">rows</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Putting document and query together</strong></p>

<p>Now the question arises: How to actually use tsvector and tsquery?  Enter the <code>@@</code> operator.  This is the operator that actually performs the search. Examples work the best, so let&rsquo;s search for a US State with the word &ldquo;North&rdquo; in it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">=#</span> <span class="k">SELECT</span>
</span><span class='line'>     <span class="n">name</span><span class="p">,</span>
</span><span class='line'>     <span class="n">to_tsvector</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">document</span>
</span><span class='line'>   <span class="k">FROM</span> <span class="n">states</span>
</span><span class='line'>   <span class="k">WHERE</span> <span class="n">to_tsvector</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">@@</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;north&#39;</span><span class="p">)</span>
</span><span class='line'>   <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">name</span> <span class="k">ASC</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">name</span>      <span class="o">|</span>        <span class="n">document</span>
</span><span class='line'><span class="c1">----------------+------------------------</span>
</span><span class='line'> <span class="n">North</span> <span class="n">Carolina</span> <span class="o">|</span> <span class="s1">&#39;carolina&#39;</span><span class="p">:</span><span class="mi">2</span> <span class="s1">&#39;north&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">North</span> <span class="n">Dakota</span>   <span class="o">|</span> <span class="s1">&#39;dakota&#39;</span><span class="p">:</span><span class="mi">2</span> <span class="s1">&#39;north&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'><span class="p">(</span><span class="mi">2</span> <span class="k">rows</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<p>Or, let&rsquo;s search for a state that has a word that starts with &ldquo;CA&rdquo;:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">=#</span> <span class="k">SELECT</span>
</span><span class='line'>     <span class="n">name</span><span class="p">,</span>
</span><span class='line'>     <span class="n">to_tsvector</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">document</span>
</span><span class='line'>   <span class="k">FROM</span> <span class="n">states</span>
</span><span class='line'>   <span class="k">WHERE</span> <span class="n">to_tsvector</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">@@</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;ca:*&#39;</span><span class="p">)</span>
</span><span class='line'>   <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">name</span> <span class="k">ASC</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">name</span>      <span class="o">|</span>        <span class="n">document</span>
</span><span class='line'><span class="c1">----------------+------------------------</span>
</span><span class='line'> <span class="n">California</span>     <span class="o">|</span> <span class="s1">&#39;california&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">North</span> <span class="n">Carolina</span> <span class="o">|</span> <span class="s1">&#39;carolina&#39;</span><span class="p">:</span><span class="mi">2</span> <span class="s1">&#39;north&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">South</span> <span class="n">Carolina</span> <span class="o">|</span> <span class="s1">&#39;carolina&#39;</span><span class="p">:</span><span class="mi">2</span> <span class="s1">&#39;south&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'><span class="p">(</span><span class="mi">3</span> <span class="k">rows</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And that is your standard text search spanning multiple rows of a table.  A friendly, neighbourhood text-search is just a WHERE clause away! Another clear takeaway here is that any <code>@@</code> operation is no different from your average <code>=</code> operation.  Naturally, a multi-table search is just a join away. Multi-column searches are just a concatenation away.</p>

<p>However, what I like about this idea is that I can now compose this search with my existing SQL queries.  Let&rsquo;s say I have a query for &ldquo;all contacts of a user that have a facebook profile&rdquo;, and now I can &ldquo;name search&rdquo; in just this subset.  To me, this is the best use-case of having the search built-in.  Composability is a very powerful design pattern.</p>

<p>A note on <code>NULL</code>s:  As with everything in Postgres, text-search doesn&rsquo;t quite work well with NULLs.  If you have null columns, <a href="https://www.postgresql.org/docs/9.6/static/functions-conditional.html">COALESCE</a> is your friend, use it liberally!</p>

<p><strong>Search relevance and rankings</strong></p>

<p>Searches are often centered around finding &ldquo;all matching documents&rdquo;, rather than finding a specific document.  In its most basic form, search relevance boils down to two questions:</p>

<ol>
<li>How do I rank the results returned by the search?</li>
<li>How do I control the ranking based on my context and requirements?</li>
</ol>


<p>Answer to the first question is the <code>ts_rank</code> function.  It accepts a tsvector and a tsquery as an argument, and returns the &ldquo;rank&rdquo;; which is a bit of a misnomer, because unlike a regular rank, where 1 is better than 2 is better than 3, this rank has the property &ldquo;higher the better&rdquo;.  It&rsquo;s best used in the ORDER clause.  Here&rsquo;s an example, searching all people whose name starts with &ldquo;Eliz&rdquo;. If that sounds odd, think autocomplete :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">=#</span> <span class="k">SELECT</span>
</span><span class='line'>     <span class="n">first_name</span><span class="p">,</span>
</span><span class='line'>     <span class="n">ts_rank</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="n">first_name</span><span class="p">),</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;eliz:*&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">rank</span>
</span><span class='line'>   <span class="k">FROM</span> <span class="n">person_names</span>
</span><span class='line'>   <span class="k">WHERE</span> <span class="n">to_tsvector</span><span class="p">(</span><span class="n">first_name</span><span class="p">)</span> <span class="o">@@</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;eliz:*&#39;</span><span class="p">)</span>
</span><span class='line'>   <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">rank</span> <span class="k">DESC</span>
</span><span class='line'>   <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">first_name</span>    <span class="o">|</span>   <span class="n">rank</span>
</span><span class='line'><span class="c1">-----------------+-----------</span>
</span><span class='line'> <span class="n">Elizabeth</span> <span class="n">Eliza</span> <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1215850</span>
</span><span class='line'> <span class="n">Elizabeth</span>       <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0607927</span>
</span><span class='line'> <span class="n">Elizabeth</span>       <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0607927</span>
</span><span class='line'> <span class="n">Elizabeth</span>       <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0607927</span>
</span><span class='line'> <span class="n">Elizabeth</span>       <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0607927</span>
</span><span class='line'> <span class="n">Elizabeth</span>       <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0607927</span>
</span><span class='line'> <span class="n">Elizabeth</span>       <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0607927</span>
</span><span class='line'> <span class="n">Elizabeth</span>       <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0607927</span>
</span><span class='line'> <span class="n">ELIZABETH</span>       <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0607927</span>
</span><span class='line'> <span class="n">Elizabeth</span>       <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0607927</span>
</span></code></pre></td></tr></table></div></figure>


<p>I think you will find that absolute rank isn&rsquo;t as useful as being able to order results by it.  That brings us to the next question, how can the ts_rank function be configured?  Say, you are searching blog posts, and want a match in title to carry more weight than a match in the body.  For this, Postgres offers &ldquo;weights&rdquo;.  The weights are called as A, B, C and D, in the order of precedence.  The default value for these weights are 1.0, 0.4, 0.2, 0.1.  Which means a match with A carries 10 times more weight than a match with D.</p>

<p>Think of these weights as &ldquo;tags&rdquo;, i.e. you tag a tsvector as A or B or C or D, and specify which tags carry how much weight. With that, Postgres will yield appropriate rank.  The tags analogy will make more sense once we look at how tsquery uses these weights.  Here&rsquo;s a query to demonstrate using weights in tsvector:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">=#</span> <span class="k">SELECT</span> <span class="n">ts_rank</span><span class="p">(</span>
</span><span class='line'>           <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;With great power&#39;</span><span class="p">),</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>           <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;comes great responsibility!&#39;</span><span class="p">),</span> <span class="s1">&#39;D&#39;</span><span class="p">),</span>
</span><span class='line'>           <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;power&#39;</span><span class="p">))</span>
</span><span class='line'>  <span class="k">AS</span> <span class="n">rank</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">rank</span>
</span><span class='line'><span class="c1">----------</span>
</span><span class='line'> <span class="mi">0</span><span class="p">.</span><span class="mi">607927</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span> <span class="n">ts_rank</span><span class="p">(</span>
</span><span class='line'>           <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;With great power&#39;</span><span class="p">),</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>           <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;comes great responsibility!&#39;</span><span class="p">),</span> <span class="s1">&#39;D&#39;</span><span class="p">),</span>
</span><span class='line'>           <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;responsibility&#39;</span><span class="p">))</span>
</span><span class='line'>   <span class="k">AS</span> <span class="n">rank</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">rank</span>
</span><span class='line'><span class="c1">----------</span>
</span><span class='line'> <span class="mi">0</span><span class="p">.</span><span class="mi">0607927</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our document here is made up of two parts, &ldquo;with great power&rdquo;, tagged A, and &ldquo;comes great responsibility&rdquo;, tagged D.</p>

<p>The rank for &ldquo;power&rdquo; is 10 times higher than &ldquo;responsibility&rdquo; when searching this document, because &ldquo;power&rdquo; is in group A, while responsibility is in group D.  Without the weights, or with same weights to all components, they will have the same rank.</p>

<p>The default assignment of weights A = 1, B = 0.4, C = 0.2 and D = 0.1 can be changed.  Refer to the documentation for variations of <code>ts_rank</code> that accept weights as an argument.  Playing around with the values in the psql console would give you an idea what works best for you.  I&rsquo;ve often found that the default values really do work the best.</p>

<p>Coming back to the tags analogy, these same weights can also be assigned to a tsquery object, and the query would then match only amongst the given weight groups. Quite like a &ldquo;filter&rdquo;.  This allows for features like &ldquo;match this, but not that&rdquo;.  Have a look:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">=#</span> <span class="k">SELECT</span> <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;With great power&#39;</span><span class="p">),</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
</span><span class='line'>     <span class="o">||</span> <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;comes great responsibility!&#39;</span><span class="p">),</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
</span><span class='line'>     <span class="o">@@</span>
</span><span class='line'>     <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;resp:*B&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">AS</span> <span class="n">is_match</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'> <span class="n">is_match</span>
</span><span class='line'><span class="c1">----------</span>
</span><span class='line'> <span class="n">f</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span> <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;With great power&#39;</span><span class="p">),</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
</span><span class='line'>     <span class="o">||</span> <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;comes great responsibility!&#39;</span><span class="p">),</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
</span><span class='line'>     <span class="o">@@</span>
</span><span class='line'>     <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;resp:*A&#39;</span><span class="p">)</span>
</span><span class='line'>   <span class="k">AS</span> <span class="n">is_match</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'> <span class="n">is_match</span>
</span><span class='line'><span class="c1">----------</span>
</span><span class='line'> <span class="n">t</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <a href="https://www.postgresql.org/docs/current/static/textsearch-controls.html">official documentation</a> about controlling text search is quite good, and detailed.  I highly recommend that you read at least this section of the documentation, if not all of it.</p>

<p>This concludes the post about basic full-text search in Postgres. Have fun searching!  Do let me know what curious cases you tried out with tsquery and tsvectors.</p>

<p>In a follow-up post, we&rsquo;ll look at improving search performance by indexing, fuzzy matching, text highlighting and supporting multiple languages.</p>

<!-- Links -->



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[10 actions you must internalize in your Editor]]></title>
    <link href="http://info.pagnis.in/blog/2014/05/06/10-actions-you-must-internalize/"/>
    <updated>2014-05-06T10:45:07+05:30</updated>
    <id>http://info.pagnis.in/blog/2014/05/06/10-actions-you-must-internalize</id>
    <content type="html"><![CDATA[<p>We love our Emacs vs Vim vs &lt;others&gt; debates.  In one argument Emacs rocks, in another Vim wins the day and in some other, TextMate takes the cake.  However, more than we love our editors, we love being productive; after all that is all what this is about.  By now, we know that the joy of writing code is well augmented by a good editor. It acts like a great force multiplier.  We go to great lengths to curate the editor &amp; its configuration to what suits us.</p>

<p>What happens when you want to use a different editor? <!-- more --> Or the same editor with different dotfiles?  They say that opening an editor and finding someone else&rsquo;s dotfiles is like going to bed and finding someone else&rsquo;s partner there.  From the outset, looks like an extremely awkward and uncomfortable experience. But, great if you were looking to switch.  So how do you learn an editor in order to be effective enough; enough being the keyword here?  The short answer to this is &ldquo;do the grunt work and put in the time&rdquo;.  However, I think all is not lost and learning a few actions as the first thing can save you a lot of time.  I often keep a cheat sheet ready with these actions in order to build the required muscle memory.</p>

<p>Now, this list is of course not complete.  A lot of things could be added to it or removed from it.  However, this is my recipe for quickly learning an editor.  And I would love to hear yours.  One thing to keep in mind is that this is not an exhaustive list of features that our editors must have.  No.  This is a list that we as programmers can use to quickly pass the learning curve of an editor.</p>

<p>I say <em>10</em>, but, it could well be <em>16</em>.  The point is having a minimum viable list.</p>

<ol>
<li><strong>Navigation within the file, moving around.</strong>  This is the most fundamental and the very first thing you&rsquo;ll probably do.  If in Emacs you can&rsquo;t C-n C-p C-f or C-b your way around, you&rsquo;ll feel exasperated soon.  So first thing to learn would be move the caret forward and backward.  There are different flavours to moving around:

<ol>
<li>One character at a time</li>
<li>One word at a time</li>
<li>One line at a time</li>
<li>One paragraph at a time etc.</li>
</ol>
</li>
<li><p><strong>Select, cut, copy and paste.</strong>  This comes naturally from Point 1.  Once you are able to move around, you would want to move text around.  Selecting text is also extremely important.  You don&rsquo;t have to use your mouse to actually select.  Selection is actually demarcation, and it works a scope.  Select a bunch of text and then perform an action only on that text.  I&rsquo;ll elaborate on this further down the list. <small> &lt;rant&gt; This ability is overrated and often superseded by others actions in the list. &lt;/rant&gt; </small></p></li>
<li><p><strong>Duplicate, delete, move and displace lines and blocks.</strong>  When working with code, we often work with whole lines, rather than words or characters. Which is why this ability comes extremely handy.  It is best used while refactoring code or formatting code.  I cannot stress how important this is.  Duplicating lines and them moving them around is indispensable.  Once you&rsquo;ve learned to use this well, I&rsquo;ll bet you would be uncomfortable without it.</p></li>
<li><p><strong>Search and replace strings and regular expressions; scoped or not.</strong>  Search and replace, combined with text selection that acts as scope is an integral part of refactoring code.  When I think of S&amp;R, I think of renaming variables, functions, classes.  I think of upgrading from <code>:key =&gt; value</code> to <code>key: value</code>.  I think of upgrading from Bootstrap 2 to Bootstrap 3, where <code>span12</code> becomes <code>col-md-12</code>.  You get the point.  As a side note, if you are building an editor to learn something new, this can a fun feature to implement.  Go ahead and try if it suits you.</p></li>
<li><p><strong>Quickly generate boilerplate code.</strong>  Once you are past the steeper part of the learning curve of a language technology, boilerplate manifests as the killer of you productivity and brings death to it by boredom. Unless, you have tuned your editor to snuff it out quickly.  Type <code>def&lt;tab&gt;</code> and boom, you have a method definition placeholder. <code>cla&lt;tab&gt;</code> and you have class declaration, <code>for&lt;tab&gt;</code> you have your block ready. etc. etc.  More than the terse languages like Ruby, Python, this will be more handy in verbose languages like Java, Objective C.</p></li>
<li><p><strong>Quickly jump to recently used files. Jump to any file within the project in few keystrokes.</strong>  <code>Command+T</code> in TextMate <code>Control-P</code> in Vim etc.  When working on a project, the impact this feature can have is tremendous.  One of the best use cases is jumping to last file.  I often find that I typically work with 2 files at a time ( Model and the Controller or The presenter and the view, the header and the implementation, Model and its Tests etc. ).  So I need to be able switch to other file fast.  In Emacs, <code>C-x b &lt;enter&gt;</code>, in TextMate <code>Command-T &lt;enter&gt;</code>, in RubyMine <code>Command-e &lt;enter&gt;</code> do the job quite fantastically for me.  In fact, as a principle, I do not use editors where this isn&rsquo;t possible or isn&rsquo;t fast enough ( I am looking at you Eclipse and Netbeans ).  Most editors who do this well allow you to perform &ldquo;partial name search&rdquo; i.e. searching for bdct will return *broadcast* amongst others.  Folder scoping is also often allowed. i.e. searching for <code>a/v/a/bdht</code> can return <code>app/views/admin/_broadcast.html.erb</code>.</p></li>
<li><p><strong>See or edit different parts of the same file or vertical &amp; horizontal split views.</strong>  When jumping between the files is not enough, you need to be able to look at the files at the same time, or look at different parts of the same file.  E.g. while editing markdown, you&rsquo;ll want live preview on right.  Or while writing a public API for your class, you&rsquo;ll want to look at the private methods etc.  In another case, you&rsquo;ll want to open up a REPL on the side while you edit code and periodically send code to the REPL for evaluation.  Use cases are plenty and hence this is a part of this list.</p></li>
<li><p><strong>Dumb autocomplete.</strong>  Your editor and you should know how to quickly complete words in the same file, words typed before, keywords in the current language (programming or not).  <code>C-\</code> in Emacs, <code>Alt-/</code> in IntelliJ or <code>Escape</code> in TextMate are good examples of this.  Fancy, code aware completions are heavily IDE dependent and very hard to get right.  But dumb completions can be fast and very handy.</p></li>
<li><p><strong>Run a test or open a shell.</strong>  I love my <code>Ctrl+Shift+R</code> in RubyMine where it runs the test I am currently editing or the test file I am currently editing, depending on where my caret is.  Same goes for <code>Command+Shift+R</code> in TextMate. In Emacs <code>M-x shell</code> opens the terminal within Emacs and use it often, for running tasks, creating files, git commits, etc.</p></li>
<li><p><strong>Comment and uncomment code.</strong>  I contemplated whether this should be a part of this list and decided to keep it.  When working on existing code, commenting and uncommenting can be extremely valuable.</p></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Console your gems: Add REPL to them]]></title>
    <link href="http://info.pagnis.in/blog/2014/04/28/console-repl-for-your-gems/"/>
    <updated>2014-04-28T12:27:34+05:30</updated>
    <id>http://info.pagnis.in/blog/2014/04/28/console-repl-for-your-gems</id>
    <content type="html"><![CDATA[<p>When you are working on a Ruby gem or a Ruby library ( why you would have a Ruby library that isn&rsquo;t a gem is beyond me ), it is <s>always</s> often desirable to have a Pry session loaded with the gem your working on.  In fact, I&rsquo;ll go out on a limb and say that REPL driven development is a a must-do when writing libraries.  REPLs are like ice added to your beer when it isn&rsquo;t cold anymore, except this ice is made from the same beer.</p>

<!-- more -->


<p>A lot of gems ship with this functionality, but if not, it is extremely easy to add one.  To avoid polluting every gem with our code, we can utilize the concept of Rake&rsquo;s global tasks.  Rake&rsquo;s default source for looking at tasks or <span title="Google it">rules</span> is the Rakefile and all files that are declared as source files in the Rakefile; typically <code>*.rake</code> files in your tasks folder, but this can vary depending on your project.  However, rake also looks at <code>~/.rake/*.rake</code> if we ask it to. So let&rsquo;s create a file called <code>~/.rake/console.rake</code> and add the following task to it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s2">&quot;Open a pry (or irb) session preloaded with this gem&quot;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:console</span> <span class="k">do</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>    <span class="nb">require</span> <span class="s1">&#39;pry&#39;</span>
</span><span class='line'>    <span class="n">gem_name</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="p">)</span>
</span><span class='line'>    <span class="n">sh</span> <span class="sx">%{pry -I lib -r </span><span class="si">#{</span><span class="n">gem_name</span><span class="si">}</span><span class="sx">.rb}</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="no">LoadError</span> <span class="o">=&gt;</span> <span class="n">_</span>
</span><span class='line'>    <span class="n">sh</span> <span class="sx">%{irb -rubygems -I lib -r </span><span class="si">#{</span><span class="n">gem_name</span><span class="si">}</span><span class="sx">.rb}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And run our shiny new rake task:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">‚ûú</span>  <span class="n">awesome_sauce</span> <span class="ss">git</span><span class="p">:(</span><span class="n">master</span><span class="p">)</span> <span class="err">‚úó</span> <span class="n">rake</span> <span class="n">console</span>
</span><span class='line'><span class="n">rake</span> <span class="n">aborted!</span>
</span><span class='line'><span class="no">Don</span><span class="s1">&#39;t know how to build task &#39;</span><span class="n">console</span><span class="err">&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="no">See</span> <span class="n">full</span> <span class="n">trace</span> <span class="n">by</span> <span class="n">running</span> <span class="n">task</span> <span class="n">with</span> <span class="o">--</span><span class="n">trace</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Bummer! Let&rsquo;s double check:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">‚ûú</span>  <span class="n">awesome_sauce</span> <span class="ss">git</span><span class="p">:(</span><span class="n">master</span><span class="p">)</span> <span class="err">‚úó</span> <span class="n">rake</span> <span class="o">-</span><span class="n">T</span> <span class="n">console</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nothing! What gives?  Not a cause of worry, because this is the expected behaviour, and we have a failing test. Rake takes global pollution quite seriously, and <em>does not</em> load the global tasks unless asked to.  So let&rsquo;s ask rake to do so, by adding a <code>-g</code> flag.  Because, you know, g for global:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">‚ûú</span>  <span class="n">awesome_sauce</span> <span class="ss">git</span><span class="p">:(</span><span class="n">master</span><span class="p">)</span> <span class="err">‚úó</span> <span class="n">rake</span> <span class="o">-</span><span class="n">gT</span> <span class="n">console</span>
</span><span class='line'><span class="n">rake</span> <span class="n">console</span>  <span class="c1"># Open a pry (or irb) session preloaded with this gem</span>
</span></code></pre></td></tr></table></div></figure>


<p>And subsequently</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">‚ûú</span>  <span class="n">awesome_sauce</span> <span class="ss">git</span><span class="p">:(</span><span class="n">master</span><span class="p">)</span> <span class="err">‚úó</span> <span class="n">rake</span> <span class="o">-</span><span class="n">g</span> <span class="n">console</span>
</span><span class='line'><span class="n">pry</span> <span class="o">-</span><span class="n">I</span> <span class="n">lib</span> <span class="o">-</span><span class="n">r</span> <span class="n">awesome_sauce</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">1</span> <span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mi">0</span> <span class="o">&gt;</span>
</span><span class='line'><span class="c1"># Just to be sure</span>
</span><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">1</span> <span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="o">^</span><span class="n">D</span>
</span><span class='line'><span class="err">‚ûú</span>  <span class="n">awesome_sauce</span> <span class="ss">git</span><span class="p">:(</span><span class="n">master</span><span class="p">)</span> <span class="err">‚úó</span> <span class="n">cd</span> <span class="o">.</span><span class="n">.</span><span class="o">/</span><span class="n">secret_sauce</span>
</span><span class='line'><span class="err">‚ûú</span>  <span class="n">secret_sauce</span> <span class="ss">git</span><span class="p">:(</span><span class="n">hush</span><span class="o">-</span><span class="n">hush</span><span class="p">)</span> <span class="err">‚úó</span> <span class="n">rake</span> <span class="o">-</span><span class="n">g</span> <span class="n">console</span>
</span><span class='line'><span class="n">rbx</span><span class="o">-</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">1</span> <span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mi">0</span> <span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this, I bow out and promise to come back with more palatable content later.</p>

<p><strong>Edit</strong>: As <a href="https://twitter.com/emilsoman">Emil</a> pointed out, <code>pry</code> uses the same trick in <code>pry --gem</code><a href="https://github.com/pry/pry/blob/01360a684443f9e516578566afe6f41d92f63419/lib/pry/cli.rb#L209"><sup>#</sup></a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[I am speaking at RubyConf India]]></title>
    <link href="http://info.pagnis.in/blog/2014/02/09/i-am-speaking-at-rubyconf-india/"/>
    <updated>2014-02-09T23:45:07+05:30</updated>
    <id>http://info.pagnis.in/blog/2014/02/09/i-am-speaking-at-rubyconf-india</id>
    <content type="html"><![CDATA[<p><a href="http://rubyconfindia.org/2014">India&rsquo;s premier Ruby conference</a> is happening at Goa this year, in the third week of March.  This year, my talk proposal got accepted and I am up on <a href="http://rubyconfindia2014.busyconf.com/schedule#activity_52cce8d8852da40010000095">day 1 at 2.30pm</a>.</p>

<!-- more -->


<p>I&rsquo;ve been digging into real time web applications for the last few months and SSE (Server Sent Events) and WebRTC caught my attention.  <a href="http://pusher.com/">Pusher</a>, a fantastic service that allows you easily implement a pub/sub model in your application, uses SSE as a transport.  And <a href="http://www.webrtc.org/">WebRTC</a> is a recent addition to the fore. Well, not so recent, as Google open sourced it in 2011.  A standard API is currently being drafted by the W3C.</p>

<p>These technologies allow two-way communication between server and client and you no longer have to depend on polling to update the clients.  There are arguments that this breaks the hypermedia agreement, and is harder to scale than traditional stateless Request/Response style of serving web resources.  I haven&rsquo;t yet formed an opinion on this, because I am clearly blinded by the awesomeness and ease of using these technologies.</p>

<p>In my talk I aim to introduce the concepts to the audience and then follow it up with code examples and best practises.  As most of the audience would be interested hear about Rails integration, I will cover all examples in the Rails context.  If you are going to be there, do read the Wikipedia page of the involved concepts and then come to the talk, I am certain you will gain a lot more this way.</p>

<p>Oh and I forgot to mention, RubyConfIndia offers this awesome badge:</p>

<p><a href="http://rubyconfindia.org/"><img src="https://raw.githubusercontent.com/rubyconfindia/rci2014/master/images/badges/180/speaker.png"></a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Hello, world!]]></title>
    <link href="http://info.pagnis.in/blog/2014/01/08/hello/"/>
    <updated>2014-01-08T14:49:26+05:30</updated>
    <id>http://info.pagnis.in/blog/2014/01/08/hello</id>
    <content type="html"><![CDATA[<p>Wikipedia tells us:</p>

<blockquote><p>A &ldquo;Hello World&rdquo; program has become the traditional first program that many people learn. In general, it is simple enough so that people who have no experience with computer programming can easily understand it, especially with the guidance of a teacher or a written guide. Using this simple program as a basis, computer science principles or elements of a specific programming language can be explained to novice programmers. Experienced programmers learning new languages can also gain a lot of information about a given language&rsquo;s syntax and structure from a hello world program.</p></blockquote>
]]></content>
  </entry>
  
</feed>
