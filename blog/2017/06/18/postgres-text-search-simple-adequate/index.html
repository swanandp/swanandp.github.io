
<!DOCTYPE HTML>
<html>
<head>
    <script type="text/javascript" src="//use.typekit.net/dye4uvz.js"></script>
    <script type="text/javascript">try { Typekit.load({ async: true }); } catch (e) { }</script>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <meta charset="utf-8">
    <title>
        Postgres Text Search: Simple, Adequate | Swanand Pagnis
    </title>

    <meta name="author" content="Swanand Pagnis">

    

    <meta name="description" content="Searching for text within your data is a frequently requested feature, and often leads to excellent UX. Gmail&rsquo;s web interface is entirely &hellip;">

    
        <meta name="keywords" content="">
    

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link href="/atom.xml" rel="alternate" title="Swanand Pagnis" type="application/atom+xml">
    <link rel="canonical" href="">
    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link href="/favicon.ico" rel="icon" type="image/x-icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    
</head>



<body>
	<header id="header" class="inner"><h1><a href="/">Swanand Pagnis</a></h1>
<h4>Essays, Blogs, Rants and Experiences</h4>
<nav id="main-nav"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:swanandp.github.io">
			</form>
		</div>
	</div>
</nav>


</header>

	<div id="content" class="inner"><article class="post">
	<h2 class="title">Postgres Text Search: Simple, Adequate</h2>
	<div class="entry-content"><p>Searching for text within your data is a frequently requested feature, and often leads to excellent UX.  Gmail&rsquo;s web interface is entirely built on top of search. No wonder databases have supported basic text search operators like ~, LIKE, ILIKE etc for a long time.  But they often fall short or give inaccurate results, as we try to evolve the feature.  Say, searching in multiple languages, or searching for different variants of the same word: consider realistically, realistic, and realist, or <a href="https://www.google.co.in/#q=ruby+-jewel">searching one word, but not the other</a>.</p>

<p>This is where full-text search comes in.  <!-- more --> Postgres ships with excellent full-text search capabilities which allow us to implement text search in our application without incurring additional dependencies and operational overhead.  More over, having a built-in search allows us to compose search with other existing queries and procedures.  When I say the excellent capabilities, I mean fully-featured.  And when I say fully-featured, I mean that it supports stemming, search relevance, search highlights, fuzzy matching, and multiple languages.</p>

<p>In this post, we&rsquo;ll look at basic text search.  In particular, we&rsquo;ll look at the fundamental components of a text search, and how to use them.</p>

<p><strong>Document</strong></p>

<p>This is the source data within which we intend to search. Typically spread across multiple columns. Now, I know any search worth its salt must be able to search across multiple rows in multiple tables, but we&rsquo;ll come to that bit a little later in the post.  Postgres offers a function <code>to_tsvector</code> to obtain a search document from text.  It accepts text as an argument, and returns tsvector of the text.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="c1">-- Example 1a: tsvector</span>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span>
</span><span class='line'>   <span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;With great power, comes great responsibility!&#39;</span><span class="p">)</span>
</span><span class='line'>   <span class="k">AS</span> <span class="n">document</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">document</span>
</span><span class='line'><span class="c1">--------------------------------------------</span>
</span><span class='line'> <span class="s1">&#39;come&#39;</span><span class="p">:</span><span class="mi">4</span> <span class="s1">&#39;great&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span> <span class="s1">&#39;power&#39;</span><span class="p">:</span><span class="mi">3</span> <span class="s1">&#39;respons&#39;</span><span class="p">:</span><span class="mi">6</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- Example 1b: have strings, will concat</span>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span>
</span><span class='line'>   <span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;With great power&#39;</span> <span class="o">||</span> <span class="s1">&#39; &#39;</span> <span class="o">||</span> <span class="s1">&#39;comes great responsibility!&#39;</span><span class="p">)</span>
</span><span class='line'>   <span class="k">AS</span> <span class="n">document</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                  <span class="n">document</span>
</span><span class='line'><span class="c1">--------------------------------------------</span>
</span><span class='line'> <span class="s1">&#39;come&#39;</span><span class="p">:</span><span class="mi">4</span> <span class="s1">&#39;great&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span> <span class="s1">&#39;power&#39;</span><span class="p">:</span><span class="mi">3</span> <span class="s1">&#39;respons&#39;</span><span class="p">:</span><span class="mi">6</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- Example 1c: have tsvectors, will concat</span>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span>
</span><span class='line'>   <span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;With great power&#39;</span><span class="p">)</span>
</span><span class='line'>   <span class="o">||</span> <span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;comes great responsibility!&#39;</span><span class="p">)</span>
</span><span class='line'>   <span class="k">AS</span> <span class="n">document</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                  <span class="n">document</span>
</span><span class='line'><span class="c1">--------------------------------------------</span>
</span><span class='line'> <span class="s1">&#39;come&#39;</span><span class="p">:</span><span class="mi">4</span> <span class="s1">&#39;great&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span> <span class="s1">&#39;power&#39;</span><span class="p">:</span><span class="mi">3</span> <span class="s1">&#39;respons&#39;</span><span class="p">:</span><span class="mi">6</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>A few things are noticeable:</p>

<ol>
<li>Punctuation is gone, so is &lsquo;with&rsquo;.  All commonly occurring words that don&rsquo;t have search relevance, such as &lsquo;with&rsquo;, are removed from the documents.  These differ from language to language, and are called &ldquo;stop words&rdquo;.</li>
<li>Words are reduced to a base form. These are called as &ldquo;<a href="https://www.postgresql.org/docs/current/static/textsearch-intro.html">lexemes</a>&rdquo;; they are nothing but normalised forms of words, a term taken from <a href="https://en.wikipedia.org/wiki/Lexeme">linguistics</a>.</li>
<li>The lexemes are sorted alphabetically, There are numbers associated with the lexemes.</li>
<li>The tsvectors can be concatenated, <em>or</em> can operate on concatenated strings</li>
</ol>


<p>If you want to dig deeper into how the search actually works, these are some of the things you can read about.  For now, we&rsquo;ll focus on just one thing from this:  the to_tsvector accepted our text input, and returned a searchable value.</p>

<p>As a side note, I really like this examples driven approach to learning.  Code and examples make for easier understanding of the subject, and give the reader a starting point to dig deeper.  In that spirit, this blog post is a repl-driven-blog-post.</p>

<p><strong>Query</strong></p>

<p>The term we wish to search for.  Typically a word or a phrase , but can be any text. Even a full document if you will. For obtaining a query object from the given search string, Postgres has two functions: <code>to_tsquery</code> and <code>plainto_tsquery</code>. <code>to_tsquery</code> allows us to use control characters like wildcards, but is a lot stricter with the input. <code>plainto_tsquery</code> on the other hand doesn&rsquo;t use control characters, but escapes all the input, and is safe from SQL injection.  In this post we&rsquo;ll only look at to_tsquery since it falls in line with our &ldquo;fully featured&rdquo; requirement.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="c1">-- Example 2: tsquery</span>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;responsibility&#39;</span><span class="p">);</span>
</span><span class='line'> <span class="n">to_tsquery</span>
</span><span class='line'><span class="c1">------------</span>
</span><span class='line'> <span class="s1">&#39;respons&#39;</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- Example 3: tsquery multiple words, with escaping</span>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;great\ responsibility&#39;</span><span class="p">);</span>
</span><span class='line'>     <span class="n">to_tsquery</span>
</span><span class='line'><span class="c1">---------------------</span>
</span><span class='line'> <span class="s1">&#39;great&#39;</span> <span class="o">&amp;</span> <span class="s1">&#39;respons&#39;</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- Example 4: Wildcard search</span>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;Eliz:*&#39;</span><span class="p">);</span>
</span><span class='line'> <span class="n">to_tsquery</span>
</span><span class='line'><span class="c1">------------</span>
</span><span class='line'> <span class="s1">&#39;eliz&#39;</span><span class="p">:</span><span class="o">*</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- Example 5: Intersection (AND-ing)</span>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;Barry&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;Allen&#39;</span><span class="p">);</span>
</span><span class='line'>     <span class="o">?</span><span class="k">column</span><span class="o">?</span>
</span><span class='line'><span class="c1">-------------------</span>
</span><span class='line'> <span class="s1">&#39;barri&#39;</span> <span class="o">&amp;</span> <span class="s1">&#39;allen&#39;</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- Example 5: Union (OR-ing)</span>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;Barry&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;Wally&#39;</span><span class="p">);</span>
</span><span class='line'>     <span class="o">?</span><span class="k">column</span><span class="o">?</span>
</span><span class='line'><span class="c1">-------------------</span>
</span><span class='line'> <span class="s1">&#39;barri&#39;</span> <span class="o">|</span> <span class="s1">&#39;walli&#39;</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Examples demonstrate the various usages of to_tsquery.  Wildcards, AND and OR do exactly what you&rsquo;d expect them to do.  The key takeaway is that, these are just regular functions, like <code>LOWER</code>, <code>LENGTH</code> and so we can just use them in <em>any</em> query.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="c1">-- Example 6</span>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span>
</span><span class='line'>   <span class="n">name</span><span class="p">,</span>
</span><span class='line'>   <span class="n">to_tsvector</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">document</span>
</span><span class='line'>   <span class="k">FROM</span> <span class="n">states</span>
</span><span class='line'>   <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">name</span> <span class="k">ASC</span>
</span><span class='line'>   <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="n">name</span>         <span class="o">|</span>         <span class="n">document</span>
</span><span class='line'><span class="c1">----------------------+---------------------------</span>
</span><span class='line'> <span class="n">Alabama</span>              <span class="o">|</span> <span class="s1">&#39;alabama&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">Alaska</span>               <span class="o">|</span> <span class="s1">&#39;alaska&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">Arizona</span>              <span class="o">|</span> <span class="s1">&#39;arizona&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">Arkansas</span>             <span class="o">|</span> <span class="s1">&#39;arkansa&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">California</span>           <span class="o">|</span> <span class="s1">&#39;california&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">Colorado</span>             <span class="o">|</span> <span class="s1">&#39;colorado&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">Connecticut</span>          <span class="o">|</span> <span class="s1">&#39;connecticut&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">Delaware</span>             <span class="o">|</span> <span class="s1">&#39;delawar&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">District</span> <span class="k">of</span> <span class="n">Columbia</span> <span class="o">|</span> <span class="s1">&#39;columbia&#39;</span><span class="p">:</span><span class="mi">3</span> <span class="s1">&#39;district&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">Florida</span>              <span class="o">|</span> <span class="s1">&#39;florida&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'><span class="p">(</span><span class="mi">10</span> <span class="k">rows</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Putting document and query together</strong></p>

<p>Now the question arises: How to actually use tsvector and tsquery?  Enter the <code>@@</code> operator.  This is the operator that actually performs the search. Examples work the best, so let&rsquo;s search for a US State with the word &ldquo;North&rdquo; in it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">=#</span> <span class="k">SELECT</span>
</span><span class='line'>     <span class="n">name</span><span class="p">,</span>
</span><span class='line'>     <span class="n">to_tsvector</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">document</span>
</span><span class='line'>   <span class="k">FROM</span> <span class="n">states</span>
</span><span class='line'>   <span class="k">WHERE</span> <span class="n">to_tsvector</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">@@</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;north&#39;</span><span class="p">)</span>
</span><span class='line'>   <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">name</span> <span class="k">ASC</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">name</span>      <span class="o">|</span>        <span class="n">document</span>
</span><span class='line'><span class="c1">----------------+------------------------</span>
</span><span class='line'> <span class="n">North</span> <span class="n">Carolina</span> <span class="o">|</span> <span class="s1">&#39;carolina&#39;</span><span class="p">:</span><span class="mi">2</span> <span class="s1">&#39;north&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">North</span> <span class="n">Dakota</span>   <span class="o">|</span> <span class="s1">&#39;dakota&#39;</span><span class="p">:</span><span class="mi">2</span> <span class="s1">&#39;north&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'><span class="p">(</span><span class="mi">2</span> <span class="k">rows</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<p>Or, let&rsquo;s search for a state that has a word that starts with &ldquo;CA&rdquo;:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">=#</span> <span class="k">SELECT</span>
</span><span class='line'>     <span class="n">name</span><span class="p">,</span>
</span><span class='line'>     <span class="n">to_tsvector</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">document</span>
</span><span class='line'>   <span class="k">FROM</span> <span class="n">states</span>
</span><span class='line'>   <span class="k">WHERE</span> <span class="n">to_tsvector</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">@@</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;ca:*&#39;</span><span class="p">)</span>
</span><span class='line'>   <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">name</span> <span class="k">ASC</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">name</span>      <span class="o">|</span>        <span class="n">document</span>
</span><span class='line'><span class="c1">----------------+------------------------</span>
</span><span class='line'> <span class="n">California</span>     <span class="o">|</span> <span class="s1">&#39;california&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">North</span> <span class="n">Carolina</span> <span class="o">|</span> <span class="s1">&#39;carolina&#39;</span><span class="p">:</span><span class="mi">2</span> <span class="s1">&#39;north&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'> <span class="n">South</span> <span class="n">Carolina</span> <span class="o">|</span> <span class="s1">&#39;carolina&#39;</span><span class="p">:</span><span class="mi">2</span> <span class="s1">&#39;south&#39;</span><span class="p">:</span><span class="mi">1</span>
</span><span class='line'><span class="p">(</span><span class="mi">3</span> <span class="k">rows</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And that is your standard text search spanning multiple rows of a table.  A friendly, neighbourhood text-search is just a WHERE clause away! Another clear takeaway here is that any <code>@@</code> operation is no different from your average <code>=</code> operation.  Naturally, a multi-table search is just a join away. Multi-column searches are just a concatenation away.</p>

<p>However, what I like about this idea is that I can now compose this search with my existing SQL queries.  Let&rsquo;s say I have a query for &ldquo;all contacts of a user that have a facebook profile&rdquo;, and now I can &ldquo;name search&rdquo; in just this subset.  To me, this is the best use-case of having the search built-in.  Composability is a very powerful design pattern.</p>

<p>A note on <code>NULL</code>s:  As with everything in Postgres, text-search doesn&rsquo;t quite work well with NULLs.  If you have null columns, <a href="https://www.postgresql.org/docs/9.6/static/functions-conditional.html">COALESCE</a> is your friend, use it liberally!</p>

<p><strong>Search relevance and rankings</strong></p>

<p>Searches are often centered around finding &ldquo;all matching documents&rdquo;, rather than finding a specific document.  In its most basic form, search relevance boils down to two questions:</p>

<ol>
<li>How do I rank the results returned by the search?</li>
<li>How do I control the ranking based on my context and requirements?</li>
</ol>


<p>Answer to the first question is the <code>ts_rank</code> function.  It accepts a tsvector and a tsquery as an argument, and returns the &ldquo;rank&rdquo;; which is a bit of a misnomer, because unlike a regular rank, where 1 is better than 2 is better than 3, this rank has the property &ldquo;higher the better&rdquo;.  It&rsquo;s best used in the ORDER clause.  Here&rsquo;s an example, searching all people whose name starts with &ldquo;Eliz&rdquo;. If that sounds odd, think autocomplete :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">=#</span> <span class="k">SELECT</span>
</span><span class='line'>     <span class="n">first_name</span><span class="p">,</span>
</span><span class='line'>     <span class="n">ts_rank</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="n">first_name</span><span class="p">),</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;eliz:*&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">rank</span>
</span><span class='line'>   <span class="k">FROM</span> <span class="n">person_names</span>
</span><span class='line'>   <span class="k">WHERE</span> <span class="n">to_tsvector</span><span class="p">(</span><span class="n">first_name</span><span class="p">)</span> <span class="o">@@</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;eliz:*&#39;</span><span class="p">)</span>
</span><span class='line'>   <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">rank</span> <span class="k">DESC</span>
</span><span class='line'>   <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">first_name</span>    <span class="o">|</span>   <span class="n">rank</span>
</span><span class='line'><span class="c1">-----------------+-----------</span>
</span><span class='line'> <span class="n">Elizabeth</span> <span class="n">Eliza</span> <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1215850</span>
</span><span class='line'> <span class="n">Elizabeth</span>       <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0607927</span>
</span><span class='line'> <span class="n">Elizabeth</span>       <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0607927</span>
</span><span class='line'> <span class="n">Elizabeth</span>       <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0607927</span>
</span><span class='line'> <span class="n">Elizabeth</span>       <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0607927</span>
</span><span class='line'> <span class="n">Elizabeth</span>       <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0607927</span>
</span><span class='line'> <span class="n">Elizabeth</span>       <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0607927</span>
</span><span class='line'> <span class="n">Elizabeth</span>       <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0607927</span>
</span><span class='line'> <span class="n">ELIZABETH</span>       <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0607927</span>
</span><span class='line'> <span class="n">Elizabeth</span>       <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0607927</span>
</span></code></pre></td></tr></table></div></figure>


<p>I think you will find that absolute rank isn&rsquo;t as useful as being able to order results by it.  That brings us to the next question, how can the ts_rank function be configured?  Say, you are searching blog posts, and want a match in title to carry more weight than a match in the body.  For this, Postgres offers &ldquo;weights&rdquo;.  The weights are called as A, B, C and D, in the order of precedence.  The default value for these weights are 1.0, 0.4, 0.2, 0.1.  Which means a match with A carries 10 times more weight than a match with D.</p>

<p>Think of these weights as &ldquo;tags&rdquo;, i.e. you tag a tsvector as A or B or C or D, and specify which tags carry how much weight. With that, Postgres will yield appropriate rank.  The tags analogy will make more sense once we look at how tsquery uses these weights.  Here&rsquo;s a query to demonstrate using weights in tsvector:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">=#</span> <span class="k">SELECT</span> <span class="n">ts_rank</span><span class="p">(</span>
</span><span class='line'>           <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;With great power&#39;</span><span class="p">),</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>           <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;comes great responsibility!&#39;</span><span class="p">),</span> <span class="s1">&#39;D&#39;</span><span class="p">),</span>
</span><span class='line'>           <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;power&#39;</span><span class="p">))</span>
</span><span class='line'>  <span class="k">AS</span> <span class="n">rank</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">rank</span>
</span><span class='line'><span class="c1">----------</span>
</span><span class='line'> <span class="mi">0</span><span class="p">.</span><span class="mi">607927</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span> <span class="n">ts_rank</span><span class="p">(</span>
</span><span class='line'>           <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;With great power&#39;</span><span class="p">),</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>           <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;comes great responsibility!&#39;</span><span class="p">),</span> <span class="s1">&#39;D&#39;</span><span class="p">),</span>
</span><span class='line'>           <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;responsibility&#39;</span><span class="p">))</span>
</span><span class='line'>   <span class="k">AS</span> <span class="n">rank</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">rank</span>
</span><span class='line'><span class="c1">----------</span>
</span><span class='line'> <span class="mi">0</span><span class="p">.</span><span class="mi">0607927</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our document here is made up of two parts, &ldquo;with great power&rdquo;, tagged A, and &ldquo;comes great responsibility&rdquo;, tagged D.</p>

<p>The rank for &ldquo;power&rdquo; is 10 times higher than &ldquo;responsibility&rdquo; when searching this document, because &ldquo;power&rdquo; is in group A, while responsibility is in group D.  Without the weights, or with same weights to all components, they will have the same rank.</p>

<p>The default assignment of weights A = 1, B = 0.4, C = 0.2 and D = 0.1 can be changed.  Refer to the documentation for variations of <code>ts_rank</code> that accept weights as an argument.  Playing around with the values in the psql console would give you an idea what works best for you.  I&rsquo;ve often found that the default values really do work the best.</p>

<p>Coming back to the tags analogy, these same weights can also be assigned to a tsquery object, and the query would then match only amongst the given weight groups. Quite like a &ldquo;filter&rdquo;.  This allows for features like &ldquo;match this, but not that&rdquo;.  Have a look:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">=#</span> <span class="k">SELECT</span> <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;With great power&#39;</span><span class="p">),</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
</span><span class='line'>     <span class="o">||</span> <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;comes great responsibility!&#39;</span><span class="p">),</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
</span><span class='line'>     <span class="o">@@</span>
</span><span class='line'>     <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;resp:*B&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">AS</span> <span class="n">is_match</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'> <span class="n">is_match</span>
</span><span class='line'><span class="c1">----------</span>
</span><span class='line'> <span class="n">f</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">=#</span> <span class="k">SELECT</span> <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;With great power&#39;</span><span class="p">),</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
</span><span class='line'>     <span class="o">||</span> <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;comes great responsibility!&#39;</span><span class="p">),</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
</span><span class='line'>     <span class="o">@@</span>
</span><span class='line'>     <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;resp:*A&#39;</span><span class="p">)</span>
</span><span class='line'>   <span class="k">AS</span> <span class="n">is_match</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'> <span class="n">is_match</span>
</span><span class='line'><span class="c1">----------</span>
</span><span class='line'> <span class="n">t</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <a href="https://www.postgresql.org/docs/current/static/textsearch-controls.html">official documentation</a> about controlling text search is quite good, and detailed.  I highly recommend that you read at least this section of the documentation, if not all of it.</p>

<p>This concludes the post about basic full-text search in Postgres. Have fun searching!  Do let me know what curious cases you tried out with tsquery and tsvectors.</p>

<p>In a follow-up post, we&rsquo;ll look at improving search performance by indexing, fuzzy matching, text highlighting and supporting multiple languages.</p>

<!-- Links -->



</div>


<div class="meta">
	<div class="date">








  


<time datetime="2017-06-18T00:00:00+05:30" pubdate data-updated="true">Jun 18<span>th</span>, 2017</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/full-text-search/'>full-text-search</a>, <a class='category' href='/blog/categories/how-tos/'>how-tos</a>, <a class='category' href='/blog/categories/postgres/'>postgres</a>

</div>


	
		<span class="comments"><a href="/blog/2017/06/18/postgres-text-search-simple-adequate/#disqus_thread">Comments</a></span>
	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
<!---	<a class="addthis_counter addthis_pill_style"></a> --->
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2017

    Swanand Pagnis

<br>
Powered by Octopress.
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'pagnis';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://swanandp.github.io/blog/2017/06/18/postgres-text-search-simple-adequate/';
        var disqus_url = 'http://swanandp.github.io/blog/2017/06/18/postgres-text-search-simple-adequate/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-46877851-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>
